<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-4xl mx-auto py-8 px-4">
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
      <h1 class="text-2xl font-bold mb-2">User Portal</h1>
      <p class="text-sm text-gray-600 mb-4">Welcome to the cognitive tools and analysis portal.</p>

      <!-- Context Info -->
      <div id="contextBox" class="p-4 border border-gray-200 rounded bg-gray-50 text-sm text-gray-700">
        <p><span class="font-semibold">User:</span> <span id="ctxUser">—</span></p>
        <p><span class="font-semibold">Role:</span> <span id="ctxRole">—</span></p>
        <p><span class="font-semibold">Unit:</span> <span id="ctxUnit">—</span></p>
        <p><span class="font-semibold">Iteration:</span> <span id="ctxIter">—</span></p>
        <p><span class="font-semibold">Iteration ID:</span> <span id="ctxIterId">—</span></p>
        <p><span class="font-semibold">Question Set:</span> <span id="ctxQSet">—</span></p>
      </div>
    </div>

    <!-- Navigation -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <a href="cognitive-tool.html" class="block bg-blue-600 text-white text-center py-4 rounded-lg shadow hover:bg-blue-700">Cognitive Tool</a>
      <a href="analyze.html" class="block bg-green-600 text-white text-center py-4 rounded-lg shadow hover:bg-green-700">Analyzer</a>
      <a href="org-chart.html" class="block bg-purple-600 text-white text-center py-4 rounded-lg shadow hover:bg-purple-700">Organization Manager</a>
      <a href="table-viewer.html" class="block bg-gray-600 text-white text-center py-4 rounded-lg shadow hover:bg-gray-700">Database Table Viewer</a>
    </div>

    <a href="index.html" class="mt-6 inline-block text-sm text-gray-500">← Back to Welcome</a>

    <!-- Debug log -->
    <details class="mt-6">
      <summary class="cursor-pointer text-sm text-gray-500">Debug log (open to view)</summary>
      <pre id="debugLog" class="bg-gray-100 text-xs p-2 overflow-auto h-40"></pre>
    </details>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const roleId = params.get("role_id");
    const debugLog = document.getElementById("debugLog");

    function log(msg, obj) {
      const line = `[${new Date().toISOString()}] ${msg} ${obj ? JSON.stringify(obj) : ""}\n`;
      debugLog.textContent += line;
      console.log(msg, obj || "");
    }

    async function loadContext() {
      if (!roleId) {
        log("[portal] No role_id in URL");
        return;
      }

      log("[portal] Fetching role context for role_id=" + roleId);
      const res = await fetch(`/api/admin/get-role-context?role_id=${roleId}`);
      const data = await res.json();
      log("[portal] GET result", data);

      if (!data.success) {
        alert("Error: " + data.message);
        return;
      }

      const r = data.context;
      document.getElementById("ctxUser").textContent = r.person_name;
      document.getElementById("ctxRole").textContent = r.is_manager ? "Manager" : "Member";
      document.getElementById("ctxUnit").textContent = r.org_unit_name;
      document.getElementById("ctxIter").textContent = r.iteration_name;
      document.getElementById("ctxIterId").textContent = r.iteration_id;
      document.getElementById("ctxQSet").textContent = r.question_set;
    }

    loadContext();
  </script>
</body>
</html>

