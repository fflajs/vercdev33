<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">
  <header class="bg-gray-900 text-white p-4 text-xl font-bold">
    User Portal
  </header>

  <main class="flex-grow p-6 space-y-6 max-w-3xl mx-auto">
    <h2 class="text-lg font-semibold">Welcome to the cognitive tools and analysis portal.</h2>

    <section class="p-4 border rounded bg-white shadow">
      <h3 class="font-bold mb-2">Context</h3>
      <p><b>User:</b> <span id="ctxUser">—</span></p>
      <p><b>Role:</b> <span id="ctxRole">—</span></p>
      <p><b>Unit:</b> <span id="ctxUnit">—</span></p>
      <p><b>Iteration:</b> <span id="ctxIter">—</span></p>
      <p><b>Iteration ID:</b> <span id="ctxIterId">—</span></p>
      <p><b>Question Set:</b> <span id="ctxQset">—</span></p>
    </section>

    <section class="grid gap-4">
      <a id="linkCognitive" class="p-3 bg-blue-600 text-white rounded shadow hover:bg-blue-700 block text-center">Cognitive Tool</a>
      <a id="linkAnalyzer" class="p-3 bg-blue-600 text-white rounded shadow hover:bg-blue-700 block text-center">Analyzer</a>
      <a id="linkOrg" class="p-3 bg-blue-600 text-white rounded shadow hover:bg-blue-700 block text-center">Organization Manager</a>
      <a id="linkTable" class="p-3 bg-blue-600 text-white rounded shadow hover:bg-blue-700 block text-center">Database Table Viewer</a>
    </section>

    <a href="index.html" class="text-blue-600 hover:underline block mt-6">← Back to Welcome</a>
  </main>

  <!-- Debug section -->
  <details class="bg-gray-100 border-t p-3 text-sm">
    <summary class="cursor-pointer font-semibold">Debug log (open to view)</summary>
    <pre id="debugLog" class="whitespace-pre-wrap"></pre>
  </details>

  <script>
    function log(msg, obj) {
      const out = document.getElementById("debugLog");
      const line = `[${new Date().toISOString()}] [portal] ${msg}`;
      console.log(line, obj || "");
      out.textContent += line + (obj ? " " + JSON.stringify(obj) : "") + "\n";
    }

    async function loadContext() {
      const params = new URLSearchParams(window.location.search);
      const roleId = params.get("role_id");

      if (!roleId) {
        log("No role_id in query string");
        return;
      }

      log("Fetching role context for role_id=" + roleId);
      try {
        const res = await fetch(`/api/admin/get-role-context?role_id=${roleId}`);
        const data = await res.json();
        log("GET result", data);

        if (data.success && data.context) {
          const ctx = data.context;
          document.getElementById("ctxUser").textContent = ctx.user;
          document.getElementById("ctxRole").textContent = ctx.roleType;
          document.getElementById("ctxUnit").textContent = ctx.unitName;
          document.getElementById("ctxIter").textContent = ctx.iterName;
          document.getElementById("ctxIterId").textContent = ctx.iterId;
          document.getElementById("ctxQset").textContent = ctx.qset;

          // Wire up links with role_id handoff
          document.getElementById("linkCognitive").href = `cognitive-tool.html?role_id=${roleId}`;
          document.getElementById("linkAnalyzer").href = `analyze.html?role_id=${roleId}`;
          document.getElementById("linkOrg").href = `org-chart.html?role_id=${roleId}`;
          document.getElementById("linkTable").href = `table-viewer.html?role_id=${roleId}`;
        } else {
          log("Error fetching context", data);
        }
      } catch (err) {
        log("Exception", { error: err.message });
      }
    }

    loadContext();
  </script>
</body>
</html>

