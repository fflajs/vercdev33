<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <div class="flex-grow container mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">User Portal</h1>
    <p class="mb-6">Welcome to the cognitive tools and analysis portal.</p>

    <div id="context" class="mb-6 bg-white p-4 rounded shadow">
      <p><strong>User:</strong> <span id="ctxUser">—</span></p>
      <p><strong>Role:</strong> <span id="ctxRole">—</span></p>
      <p><strong>Unit:</strong> <span id="ctxUnit">—</span></p>
      <p><strong>Iteration:</strong> <span id="ctxIter">—</span></p>
      <p><strong>Iteration ID:</strong> <span id="ctxIterId">—</span></p>
      <p><strong>Question Set:</strong> <span id="ctxQset">—</span></p>
    </div>

    <div class="space-y-4">
      <button onclick="goTool('cognitive-tool.html')" class="w-full bg-blue-500 text-white px-4 py-2 rounded">Cognitive Tool</button>
      <button onclick="goTool('analyze.html')" class="w-full bg-green-500 text-white px-4 py-2 rounded">Analyzer</button>
      <button onclick="goTool('org-chart.html')" class="w-full bg-purple-500 text-white px-4 py-2 rounded">Organization Manager</button>
      <button onclick="goTool('table-viewer.html')" class="w-full bg-gray-700 text-white px-4 py-2 rounded">Database Table Viewer</button>
    </div>

    <div class="mt-6">
      <a href="index.html" class="text-blue-600">← Back to Welcome</a>
    </div>
  </div>

  <!-- Debug -->
  <details class="bg-gray-200 p-4 mt-6">
    <summary class="cursor-pointer">Debug log (open to view)</summary>
    <pre id="debugLog" class="text-sm"></pre>
  </details>

  <script>
    const debug = (...args) => {
      console.log(...args);
      const log = document.getElementById('debugLog');
      log.textContent += args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' ') + "\n";
    };

    const params = new URLSearchParams(window.location.search);
    const roleId = params.get("role_id");

    async function loadContext() {
      if (!roleId) {
        debug("[portal] No role_id in query string");
        return;
      }
      debug("[portal] Fetching role context for role_id=" + roleId);

      try {
        const res = await fetch(`/api/admin/get-role-context?role_id=${roleId}`);
        const data = await res.json();
        debug("[portal] GET result", data);

        if (data.success && data.context) {
          const ctx = data.context;

          // ✅ Use flat structure
          document.getElementById("ctxUser").textContent = ctx.user || "—";
          document.getElementById("ctxRole").textContent = ctx.roleType || "—";
          document.getElementById("ctxUnit").textContent = ctx.unitName || "—";
          document.getElementById("ctxIter").textContent = ctx.iterName || "—";
          document.getElementById("ctxIterId").textContent = ctx.iterId || "—";
          document.getElementById("ctxQset").textContent = ctx.qset || "—";

          debug("[portal] Context displayed", ctx);
        } else {
          debug("[portal] Error fetching context", data);
        }
      } catch (err) {
        debug("[portal] Exception", err);
      }
    }

    function goTool(page) {
      if (!roleId) {
        alert("Missing role_id context");
        return;
      }
      window.location.href = `${page}?role_id=${roleId}`;
    }

    loadContext();
  </script>
</body>
</html>

