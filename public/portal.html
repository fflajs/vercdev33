<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-lg">
    <h1 class="text-2xl font-bold mb-4">User Portal</h1>
    <p class="mb-4">Welcome to the cognitive tools and analysis portal.</p>

    <div id="context" class="mb-4 text-sm text-gray-700">
      <p>User: <span id="userName">—</span></p>
      <p>Role: <span id="roleType">—</span></p>
      <p>Unit: <span id="unitName">—</span></p>
      <p>Iteration: <span id="iterName">—</span></p>
      <p>Iteration ID: <span id="iterId">—</span></p>
      <p>Question Set: <span id="qset">—</span></p>
    </div>

    <div class="space-y-2">
      <a id="cogBtn" class="block bg-blue-600 text-white px-4 py-2 rounded text-center cursor-pointer">Cognitive Tool</a>
      <a id="anaBtn" class="block bg-green-600 text-white px-4 py-2 rounded text-center cursor-pointer">Analyzer</a>
      <a id="orgBtn" class="block bg-purple-600 text-white px-4 py-2 rounded text-center cursor-pointer">Organization Manager</a>
      <a id="dbBtn" class="block bg-gray-600 text-white px-4 py-2 rounded text-center cursor-pointer">Database Table Viewer</a>
    </div>

    <a href="index.html" class="block mt-4 text-sm text-gray-500">← Back to Welcome</a>

    <!-- Debug -->
    <details class="mt-6">
      <summary class="cursor-pointer text-sm text-gray-500">Debug log (open to view)</summary>
      <pre id="debug" class="bg-black text-green-400 text-xs p-2 rounded h-40 overflow-y-auto"></pre>
    </details>
  </div>

  <script>
    const debug = (msg, obj) => {
      const el = document.getElementById("debug");
      el.textContent += `[${new Date().toISOString()}] ${msg} ${obj ? JSON.stringify(obj) : ""}\n`;
      el.scrollTop = el.scrollHeight;
      console.log(msg, obj || "");
    };

    const params = new URLSearchParams(window.location.search);
    const roleId = params.get("role_id");
    if (!roleId) {
      debug("[portal] No role_id in query string");
    }

    async function loadContext() {
      try {
        debug("[portal] Fetching role context for role_id=" + roleId);
        const res = await fetch(`/api/admin/get-role-context?role_id=${roleId}`);
        const json = await res.json();
        debug("[portal] GET result", json);

        if (!json.success) {
          alert("Error loading context: " + json.message);
          return;
        }

        const ctx = json.context;
        document.getElementById("userName").textContent = ctx.user;
        document.getElementById("roleType").textContent = ctx.roleType;
        document.getElementById("unitName").textContent = ctx.unitName;
        document.getElementById("iterName").textContent = ctx.iterName;
        document.getElementById("iterId").textContent = ctx.iterId;
        document.getElementById("qset").textContent = ctx.qset;

        // Links
        document.getElementById("cogBtn").href = `cognitive-tool.html?role_id=${roleId}`;
        document.getElementById("anaBtn").href = `analysis.html?role_id=${roleId}`;
        document.getElementById("orgBtn").href = `org-chart.html?role_id=${roleId}`;
        document.getElementById("dbBtn").href = `table-viewer.html`;
      } catch (err) {
        debug("[portal] ERROR", err);
      }
    }

    loadContext();
  </script>
</body>
</html>

