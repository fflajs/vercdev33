<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cognitive Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tw-caret { transition: transform 0.2s; }
    details[open] summary .tw-caret { transform: rotate(90deg); }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-5xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold">Cognitive Tool</h1>
      <p id="context" class="text-sm text-gray-600 mt-1"></p>
    </header>

    <!-- Question Set Display -->
    <div id="question-container" class="hidden space-y-4 mb-8">
      <h2 class="font-semibold text-lg">Loaded Question Set</h2>
      <p id="q-info" class="text-sm text-gray-700"></p>
      <div id="questions" class="space-y-3"></div>

      <button id="submit-btn" class="rounded bg-emerald-600 text-white px-4 py-2 text-sm font-medium hover:bg-emerald-700">
        Submit Responses
      </button>
    </div>

    <!-- Debug -->
    <details class="bg-gray-900 text-gray-100 rounded-lg p-3 mt-8">
      <summary class="cursor-pointer flex items-center gap-2">
        <span class="tw-caret inline-block">▶</span>
        <span class="font-semibold">Debug log (open to view)</span>
      </summary>
      <pre id="debug" class="mt-2 whitespace-pre-wrap text-xs"></pre>
    </details>

    <div class="mt-6">
      <a href="/portal.html" class="text-sm text-blue-600 hover:underline">← Back to Portal</a>
    </div>
  </div>

  <script>
    (function () {
      const qs = new URLSearchParams(window.location.search);
      const name = qs.get("name");
      const role_id = qs.get("role_id");
      const iter_id = qs.get("iter_id");
      const qset = qs.get("qset");

      const debugEl = document.getElementById("debug");
      const contextEl = document.getElementById("context");
      const qInfoEl = document.getElementById("q-info");
      const questionContainer = document.getElementById("question-container");
      const questionsEl = document.getElementById("questions");
      const submitBtn = document.getElementById("submit-btn");

      const log = (msg, obj) => {
        const line = `[${new Date().toISOString()}] ${msg}`;
        if (obj !== undefined) {
          try { debugEl.textContent += `${line} ${JSON.stringify(obj)}\n`; }
          catch { debugEl.textContent += `${line}\n`; }
        } else debugEl.textContent += `${line}\n`;
        if (debugEl.textContent.length > 30000)
          debugEl.textContent = debugEl.textContent.slice(-20000);
      };

      async function loadQuestionSet(filename) {
        try {
          log("[cog] GET /api/admin/cog-load-set", { filename });
          const res = await fetch(`/api/admin/cog-load-set?filename=${encodeURIComponent(filename)}`);
          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data.success) throw new Error(data.message || "Failed to load question set file");

          const questions = data.data;
          log("[cog] Question set loaded", { count: questions.length });
          qInfoEl.textContent = `Loaded ${questions.length} questions from ${filename}.`;
          questionContainer.classList.remove("hidden");

          // Render first 20 (for usability)
          questionsEl.innerHTML = "";
          questions.slice(0, 20).forEach((q, idx) => {
            const div = document.createElement("div");
            div.className = "rounded border border-gray-200 bg-white p-3";
            div.innerHTML = `
              <p class="text-sm mb-1"><b>Q${idx + 1}.</b> ${q}</p>
              <input type="range" min="1" max="5" value="3" step="1" id="q_${idx}" class="w-full">
              <div class="text-xs text-gray-500">1 = Poor / 5 = Excellent</div>
            `;
            questionsEl.appendChild(div);
          });

          return questions;
        } catch (err) {
          qInfoEl.textContent = "Error: " + err.message;
          log("[cog] load error", { message: err.message });
          return [];
        }
      }

      async function submitResponses(questions) {
        try {
          const answers = questions.map((_, i) => {
            const input = document.getElementById(`q_${i}`);
            return { q: i + 1, v: Number(input?.value || 0) };
          });

          const payload = {
            person_id: role_id,
            iteration_id: iter_id,
            question_set: qset,
            answers,
          };

          log("[cog] POST /api/admin/cog-save-response", payload);
          const res = await fetch("/api/admin/cog-save-response", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data.success) throw new Error(data.message || "Failed to save response");

          alert("Responses saved successfully!");
        } catch (err) {
          alert("Error: " + err.message);
          log("[cog] submit error", { message: err.message });
        }
      }

      // INIT
      contextEl.textContent = `User: ${name} — Role ID: ${role_id} — Iteration ID: ${iter_id} — Question Set: ${qset}`;
      log("[cog] page loaded");
      loadQuestionSet(qset).then((questions) => {
        submitBtn.onclick = () => submitResponses(questions);
      });
    })();
  </script>
</body>
</html>

