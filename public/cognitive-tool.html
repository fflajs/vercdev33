<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cognitive Space Visualization</title>

  <!-- UCognos-style dependencies -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Keep older Three.js like Ubuntu version -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/controls/OrbitControls.js"></script>

  <style>
    /* --- UCognos look & feel: darker cards, compact spacing, strong sectioning --- */
    :root {
      --card-bg: #ffffff;
      --card-border: #e6e6e6;
      --card-shadow: 0 4px 14px rgba(0,0,0,0.08);
      --headline: #111827;
      --subtle: #6b7280;
      --accent: #2563eb;
      --panel-header: #0f172a;
    }

    body {
      background: #f5f6f8;
      color: #111;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .page-wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .page-title { font-size: 1.75rem; font-weight: 800; color: var(--headline); }
    .page-sub { font-size: 0.925rem; color: var(--subtle); margin-top: 4px; }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      box-shadow: var(--card-shadow);
    }
    .card-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--card-border);
      display: flex; align-items: center; justify-content: space-between;
      background: linear-gradient(180deg, #0f172a 0%, #111827 100%);
      color: #e5e7eb;
      border-radius: 14px 14px 0 0;
    }
    .card-title { font-weight: 700; letter-spacing: 0.2px; }
    .card-body { padding: 16px; }

    /* Compact slider grid – 4 per row desktop, responsive down to 1 */
    .slider-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px 16px;
    }
    @media (max-width: 1200px) {
      .slider-grid { grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    @media (max-width: 900px) {
      .slider-grid { grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 640px) {
      .slider-grid { grid-template-columns: 1fr; }
    }

    .slider-card {
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 10px 12px;
      background: #fff;
    }
    .slider-label {
      font-size: 0.86rem;
      font-weight: 600;
      color: #111827;
      line-height: 1.2;
      margin-bottom: 6px;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    .slider-row { display: flex; align-items: center; gap: 10px; }
    .slider-row input[type="range"] { flex: 1; }
    .slider-value {
      width: 36px; text-align: center; font-variant-numeric: tabular-nums;
      font-size: 0.9rem; color: #111827;
    }
    .slider-help { font-size: 0.75rem; color: var(--subtle); margin-top: 4px; }

    .section-caption { font-size: 0.85rem; color: var(--subtle); }

    /* Charts / voxel panels keep height constraints like old */
    .chart-grid {
      display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 16px;
    }
    @media (max-width: 900px) { .chart-grid { grid-template-columns: 1fr; } }

    .chart-box { height: 240px; }
    .voxel-box { height: 380px; }

    /* Code block */
    .codebox {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      white-space: pre-wrap;
      background: #0b1020;
      color: #d1d5db;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid #1f2937;
    }

    /* Buttons mimic Ubuntu feel but Tailwind-powered */
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      border-radius: 10px; font-weight: 600; padding: 10px 14px;
      border: 1px solid #1e40af; color: #fff; background: #1d4ed8;
    }
    .btn:hover { background: #1e40af; }
    .btn-outline {
      border: 1px solid #334155; background: #0f172a; color: #e5e7eb;
    }
    .btn-outline:hover { background: #111827; }
    .muted { color: var(--subtle); }
  </style>
</head>
<body>
  <div class="page-wrap">
    <!-- Header -->
    <header class="mb-5">
      <div class="page-title">Cognitive Space Visualization</div>
      <div id="context" class="page-sub"></div>
    </header>

    <!-- Survey Panel -->
    <section class="card mb-5">
      <div class="card-header">
        <div class="card-title">Survey Questions</div>
        <div class="section-caption" id="qsMeta">Loading question set…</div>
      </div>
      <div class="card-body">
        <!-- Group tabs indicator -->
        <div class="mb-3 text-sm muted">Groups: <span class="font-semibold">Q</span> (Quality Thinking), <span class="font-semibold">M</span> (Management), <span class="font-semibold">D</span> (Delivery)</div>

        <!-- Q group -->
        <div class="mb-4">
          <h3 class="font-semibold text-gray-800 mb-2">Q — Quality Thinking</h3>
          <div id="gridQ" class="slider-grid"></div>
        </div>
        <!-- M group -->
        <div class="mb-4">
          <h3 class="font-semibold text-gray-800 mb-2">M — Management</h3>
          <div id="gridM" class="slider-grid"></div>
        </div>
        <!-- D group -->
        <div>
          <h3 class="font-semibold text-gray-800 mb-2">D — Delivery</h3>
          <div id="gridD" class="slider-grid"></div>
        </div>

        <!-- Submit -->
        <div class="mt-5 flex items-center gap-3">
          <button id="btnSubmit" class="btn">Submit Responses</button>
          <button id="btnReset" class="btn btn-outline">Reset</button>
          <span id="submitMsg" class="text-sm muted"></span>
        </div>
      </div>
    </section>

    <!-- Gaussian Graphs -->
    <section class="card mb-5">
      <div class="card-header">
        <div class="card-title">Gaussian Graphs</div>
        <div class="section-caption">Live distributions for Q, M, D (μ from sliders)</div>
      </div>
      <div class="card-body">
        <div class="chart-grid">
          <div class="chart-box card p-3"><canvas id="chartQ"></canvas></div>
          <div class="chart-box card p-3"><canvas id="chartM"></canvas></div>
          <div class="chart-box card p-3"><canvas id="chartD"></canvas></div>
        </div>
      </div>
    </section>

    <!-- 3D Voxel Cube -->
    <section class="card mb-5">
      <div class="card-header">
        <div class="card-title">3D Voxel Scene</div>
        <div class="section-caption">Interactive cube (Three.js + OrbitControls)</div>
      </div>
      <div class="card-body">
        <div id="voxelWrap" class="voxel-box card relative overflow-hidden"></div>
      </div>
    </section>

    <!-- JSON Output / Debug -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">JSON Output (Preview)</div>
        <div class="section-caption">Compact view of answers payload</div>
      </div>
      <div class="card-body">
        <pre id="jsonOut" class="codebox">{}</pre>
      </div>
    </section>

    <!-- Debug log -->
    <details class="mt-6">
      <summary class="cursor-pointer text-sm text-gray-600">Debug log (open to view)</summary>
      <pre id="debug" class="mt-2 codebox"></pre>
    </details>
  </div>

  <script>
    // --- Helpers ---
    const $ = (sel) => document.querySelector(sel);
    const logEl = $('#debug');
    const log = (m, o) => {
      const line = \`[\${new Date().toISOString()}] \${m}\`;
      logEl.textContent += o ? line + ' ' + JSON.stringify(o) + "\\n" : line + "\\n";
      if (logEl.textContent.length > 45000) logEl.textContent = logEl.textContent.slice(-35000);
    };

    const qs = new URLSearchParams(location.search);
    const personName = qs.get('name') || '';
    const roleId = parseInt(qs.get('role_id') || '0', 10);
    const iterationId = parseInt(qs.get('iter_id') || '0', 10);
    const questionFile = qs.get('qset') || 'Normal_Analysis_60.json';

    let personId = null;
    let orgUnitId = null;

    const grids = { Q: $('#gridQ'), M: $('#gridM'), D: $('#gridD') };
    const jsonOut = $('#jsonOut');
    const qsMeta = $('#qsMeta');
    const ctxLine = $('#context');

    // --- Charts ---
    let chartQ, chartM, chartD;

    function gaussian(x, mu = 4, sigma = 1.25) {
      const s2 = sigma * sigma;
      return (1 / Math.sqrt(2 * Math.PI * s2)) * Math.exp(-(Math.pow(x - mu, 2)) / (2 * s2));
    }
    function buildDatasetFromValues(values) {
      const xs = Array.from({length: 71}, (_, i) => 1 + i * (7 / 70));
      const mu = values.length ? values.reduce((a,b)=>a+b,0) / values.length : 4;
      const ys = xs.map(x => gaussian(x, mu, 1.25));
      return { xs, ys, mu: parseFloat(mu.toFixed(2)) };
    }
    function ensureCharts() {
      const cfg = (label) => ({
        type: 'line',
        data: { labels: [], datasets: [{ label, data: [], borderWidth: 2, pointRadius: 0, tension: 0.25 }]},
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
          scales: { x: { display: false }, y: { display: false } } }
      });
      if (!chartQ) chartQ = new Chart($('#chartQ'), cfg('Q'));
      if (!chartM) chartM = new Chart($('#chartM'), cfg('M'));
      if (!chartD) chartD = new Chart($('#chartD'), cfg('D'));
    }
    function updateCharts() {
      ensureCharts();
      const valuesQ = collectValues('Q');
      const valuesM = collectValues('M');
      const valuesD = collectValues('D');

      const dQ = buildDatasetFromValues(valuesQ);
      const dM = buildDatasetFromValues(valuesM);
      const dD = buildDatasetFromValues(valuesD);

      const apply = (chart, ds) => {
        chart.data.labels = ds.xs;
        chart.data.datasets[0].data = ds.ys;
        chart.update();
      };
      apply(chartQ, dQ); apply(chartM, dM); apply(chartD, dD);
    }

    // --- Three.js voxel cube (minimal, like old) ---
    let renderer, scene, camera, controls, cube;
    function initVoxel() {
      const container = document.getElementById('voxelWrap');
      const w = container.clientWidth, h = container.clientHeight;
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(45, w / h, 0.1, 1000);
      camera.position.set(3, 3, 5);
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(w, h);
      container.innerHTML = '';
      container.appendChild(renderer.domElement);

      const ambient = new THREE.AmbientLight(0xffffff, 0.8);
      const dir = new THREE.DirectionalLight(0xffffff, 0.6);
      dir.position.set(3, 5, 4);
      scene.add(ambient, dir);

      const geom = new THREE.BoxGeometry(1.5, 1.5, 1.5);
      const mat = new THREE.MeshStandardMaterial({ color: 0x4f46e5, metalness: 0.2, roughness: 0.5 });
      cube = new THREE.Mesh(geom, mat);
      scene.add(cube);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      function onResize() {
        const w2 = container.clientWidth, h2 = container.clientHeight;
        camera.aspect = w2 / h2; camera.updateProjectionMatrix();
        renderer.setSize(w2, h2);
      }
      window.addEventListener('resize', onResize);

      function animate() {
        requestAnimationFrame(animate);
        cube.rotation.y += 0.004;
        controls.update();
        renderer.render(scene, camera);
      }
      animate();
    }

    // --- Question building ---
    function makeSliderCard(id, label) {
      const wrap = document.createElement('div');
      wrap.className = 'slider-card';
      wrap.innerHTML = `
        <div class="slider-label">${label}</div>
        <div class="slider-row">
          <input type="range" min="1" max="8" step="1" value="4" id="${id}" />
          <div class="slider-value" id="${id}-val">4</div>
        </div>
        <div class="slider-help">1 = Low ··· 8 = High</div>`;
      // events
      const input = wrap.querySelector('input');
      const valEl = wrap.querySelector('.slider-value');
      input.addEventListener('input', () => {
        valEl.textContent = input.value;
        updateOutputs();
      });
      return wrap;
    }

    function inferGroupAndIndex(text) {
      // Expect prefixes like "Q1", "M14", "D7". Fallback to Q if missing.
      const m = text.trim().match(/^([QMD])\s*\.?\s*(\d+)/i);
      if (m) return { group: m[1].toUpperCase(), index: parseInt(m[2], 10) };
      const m2 = text.trim().match(/^([QMD])\s*(\d+)/i);
      if (m2) return { group: m2[1].toUpperCase(), index: parseInt(m2[2], 10) };
      return { group: 'Q', index: 0 };
    }

    function buildSurveyUI(questions) {
      // Clear
      grids.Q.innerHTML = grids.M.innerHTML = grids.D.innerHTML = '';
      // Group questions by prefix
      const grouped = { Q: [], M: [], D: [] };
      questions.forEach((q, i) => {
        const text = typeof q === 'string' ? q : (q.text || q.question || String(q));
        const { group, index } = inferGroupAndIndex(text);
        grouped[group].push({ id: \`\${group}\${index || (grouped[group].length + 1)}\`, label: text });
      });
      // Sort inside groups by numeric part
      ['Q','M','D'].forEach(g => grouped[g].sort((a,b) => {
        const ai = parseInt(a.id.replace(/[^\d]/g,''))||0;
        const bi = parseInt(b.id.replace(/[^\d]/g,''))||0;
        return ai - bi;
      }));
      // Build cards
      Object.entries(grouped).forEach(([g, arr]) => {
        const grid = grids[g];
        arr.forEach(item => grid.appendChild(makeSliderCard(item.id, item.label)));
      });
      updateOutputs();
    }

    function collectValues(group) {
      const grid = grids[group];
      const inputs = grid.querySelectorAll('input[type="range"]');
      return Array.from(inputs).map(inp => Number(inp.value || 0));
    }

    function collectAllAnswers() {
      const packs = [];
      [['Q', grids.Q], ['M', grids.M], ['D', grids.D]].forEach(([g, grid]) => {
        grid.querySelectorAll('.slider-card').forEach(card => {
          const label = card.querySelector('.slider-label').textContent.trim();
          const input = card.querySelector('input[type="range"]');
          const id = input.id;
          packs.push({ id, group: g, label, value: Number(input.value) });
        });
      });
      return packs;
    }

    function updateOutputs() {
      // JSON preview
      const answers = collectAllAnswers();
      jsonOut.textContent = JSON.stringify({ person_name: personName, person_id: personId, role_id: roleId, iteration_id: iterationId, question_set: questionFile, answers }, null, 2);
      // Charts
      updateCharts();
    }

    // --- API calls ---
    async function fetchUserContext() {
      // resolve person_id, org_unit for given role_id
      const u = new URL('/api/admin/get-user-roles', location.origin);
      u.searchParams.set('name', personName);
      log('[cog] GET /api/admin/get-user-roles', { name: personName });
      const res = await fetch(u);
      const data = await res.json();
      log('[cog] roles result', data);
      if (!data.success) throw new Error(data.message || 'Failed roles');
      personId = data.user?.id || null;
      const match = (data.roles || []).find(r => r.id === roleId);
      orgUnitId = match?.org_unit_id || null;

      // context line
      const iter = match?.iterations;
      const unitName = match?.organization_units?.name || '(unit)';
      const roleType = match?.is_manager ? 'Manager' : 'Member';
      const start = iter?.start_date ? new Date(iter.start_date).toLocaleString() : '(no start date)';
      ctxLine.textContent = `User: ${personName} — Role: ${roleType} — Unit: ${unitName} — Iteration: ${iter?.name || '(unknown)'} (ID: ${iter?.id ?? iterationId}) — Start: ${start} — Question Set: ${questionFile}`;
    }

    async function loadQuestions() {
      log('[cog] GET /api/admin/cog-load-set', { filename: questionFile });
      const u = new URL('/api/admin/cog-load-set', location.origin);
      u.searchParams.set('filename', questionFile);
      const res = await fetch(u);
      const data = await res.json();
      if (!res.ok || !data.success) throw new Error(data.message || 'Failed to load question set');
      const list = Array.isArray(data.data) ? data.data : (data.data?.questions || data.data?.items || []);
      if (!Array.isArray(list) || list.length === 0) throw new Error('Question file has no items');
      qsMeta.textContent = `Loaded ${list.length} questions from ${questionFile}.`;
      buildSurveyUI(list);
    }

    async function submitAnswers() {
      const payload = {
        person_id: personId,                // required by current API validation
        iteration_id: iterationId,
        question_set: questionFile,
        answers: collectAllAnswers(),       // array of {id,group,label,value}
        // (optional future fields if backend supports upsert)
        person_role_id: roleId,
        org_unit_id: orgUnitId
      };
      log('[cog] POST /api/admin/cog-save-response', payload);
      const res = await fetch('/api/admin/cog-save-response', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.success) throw new Error(data.message || 'Submit failed');
      $('#submitMsg').textContent = 'Saved ✔';
      setTimeout(() => $('#submitMsg').textContent = '', 2000);
    }

    function resetAll() {
      document.querySelectorAll('input[type="range"]').forEach(inp => inp.value = 4);
      updateOutputs();
    }

    // --- Init ---
    (async function init() {
      try {
        $('#btnSubmit').addEventListener('click', async () => {
          try { await submitAnswers(); } catch (e) { $('#submitMsg').textContent = 'Error: ' + e.message; log('[cog] submit error', { message: e.message }); }
        });
        $('#btnReset').addEventListener('click', resetAll);

        await fetchUserContext();
        await loadQuestions();
        initVoxel();
        updateCharts();
        log('[cog] page ready');
      } catch (e) {
        log('[cog] init error', { message: e.message });
        qsMeta.textContent = 'Error: ' + e.message;
      }
    })();
  </script>
</body>
</html>

