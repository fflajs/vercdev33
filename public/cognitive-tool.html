<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Cognition Space Visualizer</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans"; background:#f3f4f6; color:#111827; }
    .container { max-width:1200px; margin:2rem auto; padding:2rem; background:#fff; border-radius:1rem; box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05); }
    .slider-grid { display:grid; grid-template-columns: repeat( auto-fit, minmax(280px, 1fr) ); gap:1rem; }
    .chart-wrap { width:100%; height:300px; }
    .voxel-wrap { width:100%; height:600px; border-radius:1rem; overflow:hidden; background:#e5e7eb; display:flex; justify-content:center; align-items:center; }
    .voxel-canvas { width:100%; height:100%; display:block; }
    .sticky-th { position:sticky; top:0; z-index:5; background:#f9fafb; }
    .debug-pre { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size:.8rem; line-height:1.2; }
  </style>
</head>
<body>
  <div class="container">
    <div class="text-center mb-6">
      <h1 class="text-3xl font-bold">Cognition Space Visualizer</h1>
      <p id="iterationBar" class="text-blue-600 font-semibold mt-1">Loading context…</p>
      <p class="text-sm text-gray-500 mt-1">UCognos layout replica — extended with live org statistics</p>
    </div>

    <div id="userContext" class="mb-6 p-3 bg-gray-100 rounded-lg border text-sm text-center"></div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <div class="p-4 bg-gray-50 rounded-lg border">
        <label class="text-lg font-semibold text-gray-800">Target</label>
        <textarea id="targetText" rows="4" class="w-full mt-2 p-2 border rounded-lg resize-y font-mono text-sm bg-white" placeholder="Overall target set by root manager…"></textarea>
        <button id="saveTargetBtn" class="mt-2 w-full p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400">Save Target</button>
      </div>
      <div class="p-4 bg-gray-50 rounded-lg border">
        <label class="text-lg font-semibold text-gray-800">Description</label>
        <textarea id="descText" rows="4" class="w-full mt-2 p-2 border rounded-lg resize-y font-mono text-sm bg-white" placeholder="Your personal description for this role…"></textarea>
        <button id="saveDescBtn" class="mt-2 w-full p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Description</button>
      </div>
    </div>

    <!-- Organization Stats -->
    <div id="statsCard" class="p-4 bg-gray-50 rounded-lg border mb-8 hidden">
      <h2 class="text-xl font-semibold text-center text-gray-800 mb-4">Organization Statistics (Active Iteration)</h2>
      <div class="overflow-auto border rounded">
        <table class="min-w-full text-sm text-left">
          <thead class="text-xs text-gray-700 uppercase bg-gray-100">
            <tr>
              <th class="px-4 py-2 sticky-th">Metric</th>
              <th class="px-4 py-2 text-center sticky-th">Count</th>
              <th class="px-4 py-2 text-center sticky-th">Percentage</th>
            </tr>
          </thead>
          <tbody id="statsBody"></tbody>
        </table>
      </div>
    </div>

    <p id="surveyIntro" class="text-gray-600 text-center mb-4"></p>
    <div class="p-6 mb-8 bg-gray-50 rounded-lg border">
      <h2 class="text-2xl font-semibold mb-4 text-center">Survey Questions</h2>
      <div id="sliders" class="slider-grid"></div>
    </div>

    <div class="p-6 bg-gray-50 rounded-lg border">
      <h2 class="text-2xl font-semibold mb-4 text-center">Computed JSON Data</h2>
      <textarea id="jsonOut" class="w-full h-48 p-4 border rounded-lg resize-none font-mono text-sm bg-gray-100" readonly></textarea>
      <div class="flex gap-4 mt-4">
        <button id="resetBtn" class="flex-1 p-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Reset</button>
        <button id="saveBtn" class="flex-1 p-3 bg-green-600 text-white rounded-lg hover:bg-green-700">Save to Server</button>
      </div>
      <span id="flash" class="text-xs mt-2 block text-center"></span>
    </div>

    <div class="p-6 mt-8 bg-gray-50 rounded-lg border">
      <h2 class="text-2xl font-semibold mb-4 text-center">Gaussian Distributions</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="chart-wrap"><canvas id="chartQ"></canvas></div>
        <div class="chart-wrap"><canvas id="chartM"></canvas></div>
        <div class="chart-wrap"><canvas id="chartD"></canvas></div>
      </div>
    </div>

    <div class="p-6 mt-8 bg-gray-50 rounded-lg border">
      <h2 class="text-2xl font-semibold mb-4 text-center">3D Voxel Scene</h2>
      <div class="voxel-wrap"><canvas id="voxelCanvas" class="voxel-canvas"></canvas></div>
      <p class="text-center mt-3 text-sm text-gray-600">Red = your rounded mean voxel. Rotate with mouse (OrbitControls).</p>
    </div>

    <details class="mt-8">
      <summary class="cursor-pointer select-none text-sm text-gray-600">Debug log (open to view)</summary>
      <div class="mt-2 p-3 bg-gray-100 border rounded">
        <pre id="debug" class="debug-pre"></pre>
      </div>
    </details>
  </div>

  <script>
    const dbg = (...a) => {
      console.log(...a);
      const pre = document.getElementById('debug');
      pre.textContent += a.map(x => (typeof x === 'string' ? x : JSON.stringify(x))).join(' ') + "\\n";
    };
    const flash = (msg, color="green") => {
      const el = document.getElementById('flash');
      el.textContent = msg;
      el.className = \`text-xs mt-2 block text-center text-\${color}-600\`;
      setTimeout(()=>{ el.textContent = "" }, 4000);
    };

    const qs = new URLSearchParams(location.search);
    const userName  = qs.get('name')      || "(unknown)";
    const roleId    = qs.get('role_id');
    const iterId    = qs.get('iter_id');
    const qsetFile  = qs.get('qset')      || "Normal_Analysis_60.json";

    async function loadActiveIteration() {
      const r = await fetch('/api/admin/active-iteration');
      const j = await r.json();
      dbg('[active-iteration]', j);
      if (j.success && j.iteration) {
        const it = j.iteration;
        const qsName = (it.question_set||'').replace('.json','').replace(/_/g,' ');
        document.getElementById('iterationBar').innerHTML =
          \`Active Iteration: <span class="font-bold">\${it.name}</span> | Question Set: <span class="font-bold">\${qsName}</span>\`;
        return it;
      } else {
        document.getElementById('iterationBar').textContent = 'No active iteration.';
        return null;
      }
    }

    async function loadOrgStats(iterId) {
      try {
        const r = await fetch(\`/api/admin/[action]?action=org-stats&iteration_id=\${iterId}\`);
        const j = await r.json();
        dbg('[org-stats]', j);
        if (j.success) {
          const tbody = document.getElementById('statsBody');
          tbody.innerHTML = "";
          j.stats.forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = \`<td class="px-4 py-2 border">\${s.metric}</td><td class="px-4 py-2 border text-center">\${s.count}</td><td class="px-4 py-2 border text-center">\${s.percentage}</td>\`;
            tbody.appendChild(tr);
          });
          document.getElementById('statsCard').classList.remove('hidden');
        }
      } catch (e) {
        dbg('org-stats error', e);
      }
    }

    async function loadQuestions(filename) {
      const url = \`/api/admin/cog-load-set?filename=\${encodeURIComponent(filename)}\`;
      const r = await fetch(url);
      const j = await r.json();
      let arr = [];
      if (Array.isArray(j.data)) arr = j.data;
      else if (j.data && typeof j.data === 'object') {
        if (j.data.Q) arr = arr.concat(j.data.Q);
        if (j.data.M) arr = arr.concat(j.data.M);
        if (j.data.D) arr = arr.concat(j.data.D);
      }
      return arr;
    }

    async function main() {
      document.getElementById('userContext').innerHTML = \`User: <b>\${userName}</b> | Role ID: <b>\${roleId}</b> | Iteration ID: <b>\${iterId}</b>\`;

      const iter = await loadActiveIteration();
      if (iter) await loadOrgStats(iter.id);

      try {
        const questions = await loadQuestions(qsetFile);
        dbg('[questions]', questions.length);
      } catch (e) {
        flash('Failed to load questions', 'red');
      }
    }

    window.addEventListener('load', main);
  </script>
</body>
</html>

