<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Database Table Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen">
  <div class="max-w-5xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Database Table Viewer</h1>
    <p class="mb-6">View current data stored in the database. Read-only mode for testing/debugging.</p>

    <div id="tables"></div>

    <button id="refreshBtn" class="bg-blue-600 text-white px-4 py-2 rounded mt-4">Refresh Now</button>
    <a href="portal.html" class="ml-6 text-blue-600">‚Üê Back to Admin Portal</a>

    <!-- Debug -->
    <details class="mt-6">
      <summary class="cursor-pointer font-bold">Debug log (open to view)</summary>
      <pre id="debug" class="bg-black text-green-400 p-2 mt-2 rounded text-sm"></pre>
    </details>
  </div>

  <script>
    const tables = ["organization_units", "iterations", "people", "person_roles", "surveys", "app_data"];
    const tablesEl = document.getElementById("tables");
    const debugEl = document.getElementById("debug");
    function log(...args) {
      const msg = `[${new Date().toISOString()}] ${args.join(" ")}\n`;
      debugEl.textContent += msg;
      console.log(...args);
    }

    async function fetchTable(table) {
      log("Fetching table:", table);
      const res = await fetch(`/api/admin/table-viewer?table=${table}`);
      const json = await res.json();
      log("Response for", table, JSON.stringify(json));

      const container = document.createElement("div");
      container.className = "mb-6";
      container.innerHTML = `<h2 class="text-xl font-semibold mb-2">${table}</h2>`;

      if (!json.success || !json.rows || json.rows.length === 0) {
        container.innerHTML += `<p class="text-gray-600">(No data)</p>`;
      } else {
        const keys = Object.keys(json.rows[0]);
        const tableEl = document.createElement("table");
        tableEl.className = "min-w-full border border-gray-300 text-sm";
        tableEl.innerHTML = `
          <thead><tr>${keys.map(k => `<th class="border px-2 py-1">${k}</th>`).join("")}</tr></thead>
          <tbody>
            ${json.rows.map(r => `<tr>${keys.map(k => `<td class="border px-2 py-1">${r[k] ?? ""}</td>`).join("")}</tr>`).join("")}
          </tbody>
        `;
        container.appendChild(tableEl);
      }
      tablesEl.appendChild(container);
    }

    async function loadAll() {
      tablesEl.innerHTML = "";
      for (const t of tables) {
        await fetchTable(t);
      }
    }

    document.getElementById("refreshBtn").addEventListener("click", loadAll);

    log("table-viewer.html loaded.");
    loadAll();
  </script>
</body>
</html>

