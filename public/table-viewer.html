<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Database Table Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Database Table Viewer</h1>
    <p class="text-sm text-gray-600 mb-6">View current data stored in the database. Read-only mode for testing/debugging.</p>

    <div id="tables" class="space-y-8"></div>

    <div class="mt-6">
      <button id="refreshBtn"
              class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Refresh Now</button>
    </div>

    <div class="mt-6">
      <a href="portal.html" class="text-blue-600 hover:underline">‚Üê Back to Admin Portal</a>
    </div>

    <details class="mt-6">
      <summary class="cursor-pointer text-sm text-gray-500">Debug log (open to view)</summary>
      <pre id="debugLog" class="bg-black text-green-400 p-2 text-xs overflow-auto h-64"></pre>
    </details>
  </div>

  <script>
    const log = (msg, obj=null) => {
      const ts = new Date().toISOString();
      document.getElementById("debugLog").textContent += `[${ts}] ${msg} ${obj ? JSON.stringify(obj) : ""}\n`;
      console.log(msg, obj);
    };

    const urlParams = new URLSearchParams(window.location.search);
    const roleId = urlParams.get("role_id");

    const tables = ["organization_units","iterations","people","person_roles","surveys","app_data"];

    async function fetchTable(name) {
      log("Fetching table: " + name);
      const res = await fetch(`/api/admin/table-viewer?table=${name}`);
      const json = await res.json();
      log("Response for " + name, json);

      const div = document.getElementById("table-" + name);
      const tbody = div.querySelector("tbody");
      tbody.innerHTML = "";

      if (!json.success) {
        tbody.innerHTML = `<tr><td colspan="99" class="text-red-600">${json.message}</td></tr>`;
        return;
      }

      const data = json.data;
      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="99" class="text-gray-500">No records found</td></tr>`;
        return;
      }

      const cols = Object.keys(data[0]);
      const thead = div.querySelector("thead tr");
      thead.innerHTML = "";
      cols.forEach(c => {
        thead.innerHTML += `<th class="border px-2 py-1 bg-gray-100">${c}</th>`;
      });

      data.forEach(row => {
        const tr = document.createElement("tr");
        cols.forEach(c => {
          const td = document.createElement("td");
          td.className = "border px-2 py-1 text-sm";
          td.textContent = row[c];
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    async function loadAll() {
      document.getElementById("tables").innerHTML = "";
      tables.forEach(name => {
        const div = document.createElement("div");
        div.id = "table-" + name;
        div.innerHTML = `<h2 class="text-xl font-semibold mb-2">${name}</h2>
                         <table class="border-collapse border w-full text-sm">
                           <thead><tr></tr></thead>
                           <tbody><tr><td>Loading...</td></tr></tbody>
                         </table>`;
        document.getElementById("tables").appendChild(div);
      });

      for (const name of tables) {
        await fetchTable(name);
      }
    }

    document.getElementById("refreshBtn").onclick = loadAll;
    log("table-viewer.html loaded.");
    loadAll();
  </script>
</body>
</html>

