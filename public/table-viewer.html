<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Database Table Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-5xl mx-auto bg-white shadow rounded p-6">
    <h1 class="text-2xl font-bold mb-2">Database Table Viewer</h1>
    <p id="context" class="text-sm text-gray-600 mb-4"></p>

    <div id="tables" class="space-y-6"></div>

    <div class="mt-6">
      <button id="refreshBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Refresh Now</button>
    </div>

    <div class="mt-6">
      <a href="admin.html" class="text-blue-600 hover:underline">&larr; Back to Admin Portal</a>
    </div>
  </div>

  <!-- Debug -->
  <details class="max-w-5xl mx-auto mt-4 bg-gray-900 text-green-400 p-3 rounded">
    <summary class="cursor-pointer">Debug log (open to view)</summary>
    <pre id="debug" class="text-xs whitespace-pre-wrap"></pre>
  </details>

  <script>
    const debug = (msg, obj=null) => {
      const line = `[${new Date().toISOString()}] [table-viewer] ${msg}` + (obj ? " " + JSON.stringify(obj) : "");
      console.log(line);
      document.getElementById("debug").textContent += line + "\n";
    };

    let context = null;
    const tables = ["organization_units","iterations","people","person_roles","surveys","app_data"];

    async function init() {
      debug("page loaded");
      const params = new URLSearchParams(window.location.search);
      const roleId = params.get("role_id");

      if (roleId) {
        debug("Using role_id=" + roleId);
        const res = await fetch(`/api/admin/get-role-context?role_id=${roleId}`);
        const data = await res.json();
        debug("get-role-context result", data);

        if (data.success) {
          context = data.context;
          document.getElementById("context").textContent =
            `User: ${context.user} — Role: ${context.roleType} — Unit: ${context.unitName} — ` +
            `Iteration: ${context.iterName} (ID: ${context.iterId}) — Question Set: ${context.qset}`;
        }
      } else {
        debug("No role_id → using Admin mode via active-iteration");
        const res = await fetch(`/api/admin/active-iteration`);
        const data = await res.json();
        debug("active-iteration result", data);

        if (data.success && data.iteration) {
          context = {
            user: "Admin",
            roleType: "Administrator",
            unitName: "(all units)",
            iterName: data.iteration.name,
            iterId: data.iteration.id,
            qset: data.iteration.question_set
          };
          document.getElementById("context").textContent =
            `Admin mode — Iteration: ${context.iterName} (ID: ${context.iterId}) — Question Set: ${context.qset}`;
        }
      }

      await loadAll();
      document.getElementById("refreshBtn").onclick = loadAll;
    }

    async function loadAll() {
      debug("Loading all tables...");
      const container = document.getElementById("tables");
      container.innerHTML = "";

      for (const t of tables) {
        await fetchTable(t, container);
      }
    }

    async function fetchTable(table, container) {
      debug("Fetching table: " + table);
      const res = await fetch(`/api/admin/table-viewer?table=${table}`);
      const data = await res.json();
      debug("Response for " + table, data);

      const div = document.createElement("div");
      div.innerHTML = `<h2 class="text-lg font-semibold mb-2">${table}</h2>`;
      const pre = document.createElement("pre");
      pre.className = "bg-gray-100 p-2 rounded text-xs overflow-x-auto";
      pre.textContent = JSON.stringify(data.success ? data.data : data, null, 2);
      div.appendChild(pre);

      container.appendChild(div);
    }

    init();
  </script>
</body>
</html>

