<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Database Table Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-5xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Database Table Viewer</h1>
    <p class="mb-6 text-gray-600">
      View current data stored in the database. Read-only mode for testing/debugging.
    </p>

    <div class="mb-6 flex gap-4">
      <button id="resetBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
        ‚ö†Ô∏è Reset Test Data
      </button>
      <button id="refreshBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        üîÑ Refresh Now
      </button>
    </div>
    <p class="text-sm text-gray-500 mb-6">
      Reset clears all tables and inserts a seed iteration. Refresh reloads the table data without touching the DB.
    </p>

    <div id="tables"></div>

    <div class="mt-6">
      <a href="admin.html" class="text-blue-600 hover:underline">&larr; Back to Admin Portal</a>
    </div>

    <!-- Debug Log -->
    <details class="mt-8">
      <summary class="cursor-pointer font-semibold">Debug log (open to view)</summary>
      <pre id="debugLog" class="bg-black text-green-400 p-3 mt-2 rounded max-h-64 overflow-y-auto text-sm"></pre>
    </details>
  </div>

  <script>
    const tables = ["organization_units", "iterations", "people", "person_roles"];
    const container = document.getElementById("tables");
    const debugEl = document.getElementById("debugLog");
    const resetBtn = document.getElementById("resetBtn");
    const refreshBtn = document.getElementById("refreshBtn");

    function log(msg, data) {
      const line = `[${new Date().toISOString()}] ${msg}` + (data ? " " + JSON.stringify(data, null, 2) : "");
      console.log(line);
      debugEl.textContent += line + "\n";
    }

    async function loadTable(name) {
      log(`[loadTable] Fetching table: ${name}`);
      try {
        const res = await fetch(`/api/admin/table-data?table=${name}`);
        log(`[loadTable] response.ok: ${res.ok}`);
        const data = await res.json();
        log(`[loadTable] JSON for ${name}:`, data);

        const section = document.createElement("div");
        section.className = "mb-6";

        const title = document.createElement("h2");
        title.className = "text-xl font-semibold mb-2";
        title.textContent = name;
        section.appendChild(title);

        if (data.success && data.rows.length > 0) {
          const table = document.createElement("table");
          table.className = "min-w-full border border-gray-300 text-sm";
          const thead = document.createElement("thead");
          thead.className = "bg-gray-200";

          const headerRow = document.createElement("tr");
          Object.keys(data.rows[0]).forEach((col) => {
            const th = document.createElement("th");
            th.className = "border px-2 py-1 text-left";
            th.textContent = col;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);

          const tbody = document.createElement("tbody");
          data.rows.forEach((row) => {
            const tr = document.createElement("tr");
            Object.values(row).forEach((val) => {
              const td = document.createElement("td");
              td.className = "border px-2 py-1";
              td.textContent = val;
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);

          section.appendChild(table);
        } else {
          const noData = document.createElement("p");
          noData.className = "text-gray-500";
          noData.textContent = "(No data)";
          section.appendChild(noData);
        }

        container.appendChild(section);
      } catch (err) {
        log(`[loadTable] Error fetching ${name}: ${err}`);
      }
    }

    async function refreshAllTables() {
      log("[refreshAllTables] Reloading all tables‚Ä¶");
      container.innerHTML = "";
      for (const t of tables) {
        await loadTable(t);
      }
    }

    async function resetData() {
      if (!confirm("‚ö†Ô∏è Are you sure you want to reset all test data?")) return;
      log("[resetBtn] Sending reset-test-data request");
      try {
        const res = await fetch("/api/admin/reset-test-data", { method: "POST" });
        log("[resetBtn] response.ok: " + res.ok);
        const data = await res.json();
        log("[resetBtn] JSON:", data);
        if (data.success) {
          alert("Database reset complete! Reloading tables‚Ä¶");
          await refreshAllTables();
        } else {
          alert("Reset failed: " + data.message);
        }
      } catch (err) {
        log("[resetBtn] Error:", err);
        alert("Reset failed: " + err);
      }
    }

    resetBtn.onclick = resetData;
    refreshBtn.onclick = refreshAllTables;

    // First load
    refreshAllTables();

    // üîÑ Auto-refresh every 30s
    setInterval(refreshAllTables, 30000);
  </script>
</body>
</html>

