<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login - Select Role</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-2xl mx-auto mt-10 p-6 bg-white shadow rounded">
    <h1 class="text-2xl font-bold mb-4">Select Your Role</h1>
    <p class="mb-4">Choose which organization unit and role you want to use for the current active iteration.</p>

    <div class="mb-4">
      <label class="block font-semibold mb-1">Available Roles</label>
      <select id="roleSelect" class="w-full border rounded p-2"></select>
    </div>

    <div id="context" class="mb-4 text-sm text-gray-700">
      <p><strong>User:</strong> <span id="userName">—</span></p>
      <p><strong>Iteration:</strong> <span id="iterName">—</span></p>
      <p><strong>Iteration ID:</strong> <span id="iterId">—</span></p>
      <p><strong>Question Set:</strong> <span id="qset">—</span></p>
    </div>

    <div class="flex space-x-4">
      <button id="continueBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Continue to Portal</button>
      <a href="index.html" class="bg-gray-500 text-white px-4 py-2 rounded">Back</a>
    </div>
  </div>

  <!-- Debug log -->
  <details class="max-w-2xl mx-auto mt-6 bg-black text-green-400 p-4 rounded">
    <summary class="cursor-pointer">Debug log (open to view)</summary>
    <pre id="debugLog" class="whitespace-pre-wrap text-xs"></pre>
  </details>

  <script>
    const log = (...args) => {
      console.log(...args);
      const pre = document.getElementById("debugLog");
      pre.textContent += args.map(a => 
        typeof a === "object" ? JSON.stringify(a) : String(a)
      ).join(" ") + "\\n";
    };

    async function loadRoles(userName) {
      try {
        log("[login-user] GET /api/admin/get-user-roles?name=" + userName);
        const res = await fetch(`/api/admin/get-user-roles?name=${encodeURIComponent(userName)}`);
        const json = await res.json();
        log("[login-user] GET result", json);

        if (!json.success) {
          alert("Failed to load roles: " + json.message);
          return;
        }

        // Fill context
        document.getElementById("userName").textContent = json.user.name;
        document.getElementById("iterName").textContent = json.iteration.name;
        document.getElementById("iterId").textContent = json.iteration.id;
        document.getElementById("qset").textContent = json.iteration.question_set;

        // Populate role dropdown
        const sel = document.getElementById("roleSelect");
        sel.innerHTML = "";
        json.roles.forEach(r => {
          const opt = document.createElement("option");
          opt.value = r.id;
          opt.textContent = `${r.organization_units?.name || "??"} - ${r.is_manager ? "Manager" : "Coworker"}`;
          sel.appendChild(opt);
        });
      } catch (err) {
        log("[login-user] Error", err);
        alert("Error loading roles");
      }
    }

    document.getElementById("continueBtn").onclick = () => {
      const roleId = document.getElementById("roleSelect").value;
      if (!roleId) {
        alert("Please select a role first.");
        return;
      }
      log("[login-user] continuing with role_id=" + roleId);
      window.location.href = `portal.html?role_id=${roleId}`;
    };

    // On load: get ?name= from URL
    const params = new URLSearchParams(window.location.search);
    const userName = params.get("name");
    log("[login-user] page loaded for", { userName });
    if (userName) {
      loadRoles(userName);
    } else {
      alert("No username specified in query string.");
    }
  </script>
</body>
</html>

