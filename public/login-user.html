<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Login - Select Role</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-lg">
    <h1 class="text-2xl font-bold mb-4">Select Your Role</h1>
    <p class="mb-4">Choose which organization unit and role you want to use for the current active iteration.</p>

    <label for="roleSelect" class="block text-sm font-medium mb-1">Available Roles</label>
    <select id="roleSelect" class="w-full border rounded p-2 mb-4"></select>

    <div id="context" class="mb-4 text-sm text-gray-700">
      <p>User: <span id="userName">—</span></p>
      <p>Iteration: <span id="iterName">—</span></p>
      <p>Iteration ID: <span id="iterId">—</span></p>
      <p>Question Set: <span id="qset">—</span></p>
    </div>

    <div class="flex gap-2">
      <button id="continueBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Continue to Portal</button>
      <a href="index.html" class="bg-gray-300 px-4 py-2 rounded">Back</a>
    </div>

    <!-- Debug -->
    <details class="mt-6">
      <summary class="cursor-pointer text-sm text-gray-500">Debug log (open to view)</summary>
      <pre id="debug" class="bg-black text-green-400 text-xs p-2 rounded h-40 overflow-y-auto"></pre>
    </details>
  </div>

  <script>
    const debug = (msg, obj) => {
      const el = document.getElementById("debug");
      el.textContent += `[${new Date().toISOString()}] ${msg} ${obj ? JSON.stringify(obj) : ""}\n`;
      el.scrollTop = el.scrollHeight;
      console.log(msg, obj || "");
    };

    const params = new URLSearchParams(window.location.search);
    const userName = params.get("name");
    debug("[login-user] page loaded for", { userName });

    async function loadRoles() {
      try {
        debug("[login-user] GET /api/admin/get-user-roles?name=" + userName);
        const res = await fetch(`/api/admin/get-user-roles?name=${encodeURIComponent(userName)}`);
        const json = await res.json();
        debug("[login-user] GET result", json);

        if (!json.success) {
          alert("Error loading roles: " + json.message);
          return;
        }

        document.getElementById("userName").textContent = json.user.name;
        document.getElementById("iterName").textContent = json.iteration.name;
        document.getElementById("iterId").textContent = json.iteration.id;
        document.getElementById("qset").textContent = json.iteration.question_set;

        const sel = document.getElementById("roleSelect");
        sel.innerHTML = "";
        json.roles.forEach(r => {
          const opt = document.createElement("option");
          opt.value = r.id;
          opt.textContent = `${r.unit?.name || "??"} - ${r.is_manager ? "Manager" : "Coworker"}`;
          sel.appendChild(opt);
        });
      } catch (err) {
        debug("[login-user] ERROR loading roles", err);
      }
    }

    document.getElementById("continueBtn").onclick = () => {
      const roleId = document.getElementById("roleSelect").value;
      if (!roleId) {
        alert("Please select a role");
        return;
      }
      debug("[login-user] continue with role_id=" + roleId);
      window.location.href = `portal.html?role_id=${roleId}`;
    };

    loadRoles();
  </script>
</body>
</html>

