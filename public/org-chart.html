<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold mb-4">Organization Manager</h1>
    <p id="iteration-info" class="mb-4 text-gray-600">Loading...</p>
    <div id="org-container" class="space-y-4"></div>
    <a href="/admin.html" class="text-blue-500 hover:underline block mt-6">← Back to Admin Portal</a>
  </div>

  <script>
    let currentIteration = null;
    let people = [];
    let activeForm = null;

    async function loadIterationAndUnits() {
      const infoEl = document.getElementById('iteration-info');
      const container = document.getElementById('org-container');
      container.innerHTML = 'Loading...';

      try {
        const res = await fetch('/api/admin/[action]?action=org-data&iteration_id=11');
        const data = await res.json();

        if (!data.success) throw new Error(data.message);

        currentIteration = data.iteration;
        people = data.people;

        infoEl.textContent = `Current Iteration: ${currentIteration.name} (ID: ${currentIteration.id})`;

        container.innerHTML = '';
        const tree = buildTree(data.units);
        tree.forEach(unit => renderUnit(unit, container, data.roles));
      } catch (err) {
        infoEl.textContent = 'Error loading iteration: ' + err.message;
        infoEl.classList.add('text-red-600');
      }
    }

    function buildTree(units) {
      const map = {};
      units.forEach(u => (map[u.id] = { ...u, children: [] }));
      const roots = [];
      units.forEach(u => {
        if (u.parent_id) {
          map[u.parent_id]?.children.push(map[u.id]);
        } else {
          roots.push(map[u.id]);
        }
      });
      return roots;
    }

    function renderUnit(unit, container, roles) {
      const div = document.createElement('div');
      div.className = 'ml-4 border-l pl-4 mt-2';

      const header = document.createElement('div');
      header.className = 'font-semibold text-lg flex items-center justify-between';

      const nameSpan = document.createElement('span');
      nameSpan.textContent = unit.name;
      header.appendChild(nameSpan);

      const addBtn = document.createElement('button');
      addBtn.textContent = '➕ Add Subunit';
      addBtn.className = 'ml-2 text-sm text-green-600 hover:underline';
      addBtn.onclick = () => showInlineSubunitForm(unit.id, div, header);
      header.appendChild(addBtn);

      div.appendChild(header);

      const unitRoles = roles.filter(r => r.org_unit_id === unit.id);
      unitRoles.forEach(role => {
        const person = people.find(p => p.id === role.person_id);
        const roleDiv = document.createElement('div');
        roleDiv.className = 'ml-6 text-sm text-gray-700 flex items-center';

        roleDiv.textContent = `- ${person?.name || 'Unknown'} (${role.is_manager ? 'Manager' : 'Member'})`;

        const delBtn = document.createElement('button');
        delBtn.textContent = '❌';
        delBtn.className = 'ml-2 text-xs text-red-500 hover:underline';
        delBtn.onclick = async () => {
          if (!confirm('Remove this role?')) return;
          const res = await fetch('/api/admin/[action]?action=delete-role', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: role.id })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data.success) {
            alert('Error removing role: ' + (data.message || res.statusText));
            return;
          }
          loadIterationAndUnits();
        };

        roleDiv.appendChild(delBtn);
        div.appendChild(roleDiv);
      });

      const assignDiv = document.createElement('div');
      assignDiv.className = 'ml-6 mt-1 flex items-center space-x-2';

      const select = document.createElement('select');
      select.className = 'border rounded px-2 py-1 text-sm';
      people.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        select.appendChild(opt);
      });

      const managerChk = document.createElement('input');
      managerChk.type = 'checkbox';
      const managerLbl = document.createElement('label');
      managerLbl.textContent = 'Manager';
      managerLbl.className = 'text-sm ml-1';

      const addRoleBtn = document.createElement('button');
      addRoleBtn.textContent = 'Assign';
      addRoleBtn.className = 'bg-blue-500 text-white px-2 py-1 rounded text-sm';
      addRoleBtn.onclick = async () => {
        const res = await fetch('/api/admin/[action]?action=assign-role', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            person_id: parseInt(select.value),
            org_unit_id: unit.id,
            is_manager: managerChk.checked,
            iteration_id: currentIteration.id
          })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) {
          alert('Error assigning role: ' + (data.message || res.statusText));
          return;
        }
        loadIterationAndUnits();
      };

      assignDiv.appendChild(select);
      assignDiv.appendChild(managerChk);
      assignDiv.appendChild(managerLbl);
      assignDiv.appendChild(addRoleBtn);
      div.appendChild(assignDiv);

      container.appendChild(div);

      unit.children.forEach(child => renderUnit(child, div, roles));
    }

    function showInlineSubunitForm(parentId, container, headerEl) {
      if (activeForm) {
        activeForm.remove();
        activeForm = null;
      }

      const form = document.createElement('div');
      form.className = 'ml-6 mt-2 p-2 border rounded bg-gray-50 flex items-center space-x-2';

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Subunit name';
      input.className = 'border rounded px-2 py-1 text-sm flex-1';

      const submitBtn = document.createElement('button');
      submitBtn.textContent = 'Create';
      submitBtn.className = 'bg-green-500 text-white px-2 py-1 rounded text-sm';
      submitBtn.onclick = async () => {
        const name = input.value.trim();
        if (!name) return alert('Please enter a name.');
        const res = await fetch('/api/admin/[action]?action=create-org-unit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, parent_id: parentId, iteration_id: currentIteration.id })
        });
        const data = await res.json();
        if (data.success) {
          loadIterationAndUnits();
        } else {
          alert('Error: ' + data.message);
        }
      };

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'bg-gray-400 text-white px-2 py-1 rounded text-sm';
      cancelBtn.onclick = () => {
        form.remove();
        activeForm = null;
      };

      form.appendChild(input);
      form.appendChild(submitBtn);
      form.appendChild(cancelBtn);

      headerEl.insertAdjacentElement('afterend', form);
      activeForm = form;
      input.focus();
    }

    loadIterationAndUnits();
  </script>
</body>
</html>

