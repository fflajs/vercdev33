<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Manager</title>
  <link rel="icon" href="/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
    <h1 class="text-3xl font-bold mb-4">Organization Manager</h1>
    <p id="iteration-info" class="mb-6 text-gray-700">Loading...</p>
    <div id="org-tree" class="ml-4"></div>

    <div class="mt-6 space-x-4">
      <a href="/admin.html" class="text-blue-500 font-bold hover:text-blue-700">
        ← Back to Admin Portal
      </a>
      <a href="/portal.html" class="text-green-600 font-bold hover:text-green-800">
        ← Back to Portal
      </a>
    </div>
  </div>

  <script>
    let currentIteration = null;

    async function loadIterationAndUnits() {
      const info = document.getElementById('iteration-info');
      const tree = document.getElementById('org-tree');
      tree.innerHTML = 'Loading...';

      try {
        const res = await fetch('/api/admin/active-iteration');
        const data = await res.json();
        if (!data.success) {
          info.textContent = 'No active iteration found.';
          tree.innerHTML = '';
          return;
        }
        currentIteration = data.iteration;
        info.textContent =
          `Current Iteration: ${data.iteration.name} (ID: ${data.iteration.id})`;

        const res2 = await fetch(`/api/admin/org-data?iteration_id=${data.iteration.id}`);
        const data2 = await res2.json();
        if (!data2.success) {
          tree.innerHTML = 'Error loading organization data';
          return;
        }

        renderOrgUnits(tree, data2.units, data2.roles, data2.people, null);
      } catch (err) {
        info.textContent = `Error loading iteration: ${err.message}`;
      }
    }

    function renderOrgUnits(container, units, roles, people, parentId) {
      const filtered = units.filter(u => u.parent_id === parentId);
      if (filtered.length === 0) return;

      const ul = document.createElement('ul');
      ul.className = 'ml-4 list-disc';

      filtered.forEach(unit => {
        const li = document.createElement('li');
        li.textContent = unit.name;

        const subRoles = roles.filter(r => r.org_unit_id === unit.id);
        if (subRoles.length > 0) {
          const roleList = document.createElement('ul');
          roleList.className = 'ml-6 list-none';
          subRoles.forEach(role => {
            const person = people.find(p => p.id === role.person_id);
            if (person) {
              const roleItem = document.createElement('li');
              roleItem.textContent = `- ${person.name} (${role.is_manager ? 'Manager' : 'Member'})`;
              roleList.appendChild(roleItem);
            }
          });
          li.appendChild(roleList);
        }

        ul.appendChild(li);
        renderOrgUnits(li, units, roles, people, unit.id);
      });

      container.appendChild(ul);
    }

    loadIterationAndUnits();
  </script>
</body>
</html>

