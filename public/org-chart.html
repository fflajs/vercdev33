<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold mb-4">Organization Manager</h1>
    <p id="iteration-display" class="text-blue-600 font-semibold mb-6">
      Loading iteration...
    </p>
    <div id="org-tree" class="space-y-2"></div>
    <a href="/admin.html"
       class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800 mt-6">
      ← Back to Admin Portal
    </a>
  </div>

  <script>
    let currentIteration = null;
    let activeForm = null;
    let hasActiveIteration = false;

    async function loadIterationAndUnits() {
      const display = document.getElementById('iteration-display');
      try {
        const res = await fetch('/api/admin/active-iteration');
        const data = await res.json();

        if (data.success && data.iteration) {
          currentIteration = data.iteration;
          hasActiveIteration = true;
          display.textContent =
            `Current Iteration: ${currentIteration.name} (ID: ${currentIteration.id})`;
          display.className = "text-blue-600 font-semibold mb-6";
          await renderOrgUnits();
        } else {
          display.textContent = "No active iteration found.";
          display.className = "text-red-600 font-semibold mb-6";
          hasActiveIteration = false;
          document.getElementById('org-tree').innerHTML = "";
        }
      } catch (err) {
        display.textContent = `Error: ${err.message}`;
        display.className = "text-red-600 font-semibold mb-6";
        hasActiveIteration = false;
        document.getElementById('org-tree').innerHTML = "";
      }
    }

    async function renderOrgUnits() {
      const res = await fetch(`/api/admin/org-data?iteration_id=${currentIteration.id}`);
      const data = await res.json();

      const container = document.getElementById('org-tree');
      container.innerHTML = "";

      if (!data.success) {
        container.textContent = "Error loading organization units.";
        return;
      }

      const units = data.units || [];
      const roles = data.roles || [];
      const people = data.people || [];

      const peopleMap = Object.fromEntries(people.map(p => [p.id, p]));

      const tree = {};
      units.forEach(u => {
        tree[u.id] = { ...u, children: [] };
      });
      units.forEach(u => {
        if (u.parent_id && tree[u.parent_id]) {
          tree[u.parent_id].children.push(tree[u.id]);
        }
      });

      const roots = Object.values(tree).filter(u => !u.parent_id);

      function renderUnit(unit, depth = 0) {
        const div = document.createElement('div');
        div.className = "ml-" + (depth * 4);

        const titleRow = document.createElement('div');
        titleRow.className = "font-bold flex items-center space-x-2";
        titleRow.textContent = unit.name + " ";

        const addBtn = document.createElement('button');
        addBtn.textContent = "➕ Add Subunit";
        addBtn.className =
          "ml-2 text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed";
        addBtn.title = hasActiveIteration
          ? "Create subunit under " + unit.name
          : "Disabled: No active iteration";
        addBtn.disabled = !hasActiveIteration;
        addBtn.onclick = () => {
          if (!hasActiveIteration) return;
          showInlineSubunitForm(unit.id, div);
        };
        titleRow.appendChild(addBtn);
        div.appendChild(titleRow);

        roles.filter(r => r.org_unit_id === unit.id).forEach(role => {
          const person = peopleMap[role.person_id];
          if (!person) return;
          const roleDiv = document.createElement('div');
          roleDiv.className = "ml-6 flex items-center space-x-2";
          roleDiv.innerHTML =
            `- ${person.name} (${role.is_manager ? "Manager" : "Member"})`;

          const delBtn = document.createElement('button');
          delBtn.textContent = "❌";
          delBtn.className =
            "text-xs bg-red-500 text-white px-1 rounded hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed";
          delBtn.title = hasActiveIteration
            ? "Remove role"
            : "Disabled: No active iteration";
          delBtn.disabled = !hasActiveIteration;
          delBtn.onclick = async () => {
            if (!hasActiveIteration) return;
            if (!confirm(`Remove ${person.name}'s role from ${unit.name}?`)) return;
            const res = await fetch('/api/admin/delete-role', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: role.id }),
            });
            const data = await res.json();
            if (data.success) {
              loadIterationAndUnits();
            } else {
              alert("Error removing role: " + data.message);
            }
          };
          roleDiv.appendChild(delBtn);
          div.appendChild(roleDiv);
        });

        const addRoleBtn = document.createElement('button');
        addRoleBtn.textContent = "➕ Add Role";
        addRoleBtn.className =
          "ml-6 text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed";
        addRoleBtn.title = hasActiveIteration
          ? "Assign a person to this unit"
          : "Disabled: No active iteration";
        addRoleBtn.disabled = !hasActiveIteration;
        addRoleBtn.onclick = () => {
          if (!hasActiveIteration) return;
          showInlineRoleForm(unit.id, div, people);
        };
        div.appendChild(addRoleBtn);

        unit.children.forEach(child => {
          div.appendChild(renderUnit(child, depth + 1));
        });

        return div;
      }

      roots.forEach(root => {
        container.appendChild(renderUnit(root));
      });
    }

    function showInlineSubunitForm(parentId, container) {
      if (activeForm) activeForm.remove();
      const form = document.createElement('div');
      form.className = 'ml-6 mt-2 p-2 border rounded bg-gray-50 flex items-center space-x-2';
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Subunit name';
      input.className = 'border rounded px-2 py-1';
      const submitBtn = document.createElement('button');
      submitBtn.textContent = 'Create';
      submitBtn.className = 'bg-green-500 text-white px-2 py-1 rounded';
      submitBtn.onclick = async () => {
        const name = input.value.trim();
        if (!name) return alert('Please enter a name.');
        const res = await fetch('/api/admin/create-org-unit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, parent_id: parentId, iteration_id: currentIteration.id })
        });
        const data = await res.json();
        if (data.success) {
          loadIterationAndUnits();
        } else {
          alert('Error: ' + data.message);
        }
      };
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'bg-gray-400 text-white px-2 py-1 rounded';
      cancelBtn.onclick = () => form.remove();
      form.appendChild(input);
      form.appendChild(submitBtn);
      form.appendChild(cancelBtn);
      container.insertBefore(form, container.children[1]);
      activeForm = form;
      input.focus();
    }

    function showInlineRoleForm(orgUnitId, container, people) {
      if (activeForm) activeForm.remove();
      const form = document.createElement('div');
      form.className = 'ml-6 mt-2 p-2 border rounded bg-gray-50 flex items-center space-x-2';

      const select = document.createElement('select');
      select.className = 'border rounded px-2 py-1';
      people.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        select.appendChild(opt);
      });

      const roleType = document.createElement('select');
      roleType.className = 'border rounded px-2 py-1';
      [{ value: true, label: "Manager" }, { value: false, label: "Member" }].forEach(optData => {
        const opt = document.createElement('option');
        opt.value = optData.value;
        opt.textContent = optData.label;
        roleType.appendChild(opt);
      });

      const submitBtn = document.createElement('button');
      submitBtn.textContent = 'Assign';
      submitBtn.className = 'bg-blue-500 text-white px-2 py-1 rounded';
      submitBtn.onclick = async () => {
        const res = await fetch('/api/admin/assign-role', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            person_id: select.value,
            org_unit_id: orgUnitId,
            is_manager: roleType.value === "true",
            iteration_id: currentIteration.id,
          }),
        });
        const data = await res.json();
        if (data.success) {
          loadIterationAndUnits();
        } else {
          alert("Error assigning role: " + data.message);
        }
      };

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'bg-gray-400 text-white px-2 py-1 rounded';
      cancelBtn.onclick = () => form.remove();

      form.appendChild(select);
      form.appendChild(roleType);
      form.appendChild(submitBtn);
      form.appendChild(cancelBtn);

      container.appendChild(form);
      activeForm = form;
    }

    loadIterationAndUnits();
  </script>
</body>
</html>

