<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Chart</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-4xl bg-white p-8 rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold mb-6 text-center">Organization Manager</h1>
    <p id="iteration-display" class="text-blue-600 font-semibold mb-4">
      Loading iteration...
    </p>

    <div id="org-container" class="space-y-4">
      <!-- Org chart will be rendered here -->
    </div>

    <div class="mt-6 text-center">
      <a href="/admin.html" class="text-blue-500 hover:underline">← Back to Admin Portal</a>
    </div>
  </div>

  <script>
    async function loadOrg() {
      const container = document.getElementById('org-container');
      const iterDisplay = document.getElementById('iteration-display');
      container.innerHTML = 'Loading...';

      try {
        const res = await fetch('/api/admin/org/snapshot');
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.message || 'Failed to load');

        // Show iteration info
        iterDisplay.textContent = `Current Iteration: ${data.iteration.name} (ID: ${data.iteration.id})`;

        // Build map for units and roles
        const units = data.units;
        const roles = data.roles;
        const people = Object.fromEntries(data.people.map(p => [p.id, p.name]));

        const byParent = {};
        units.forEach(u => {
          const parent = u.parent_id || 0;
          if (!byParent[parent]) byParent[parent] = [];
          byParent[parent].push(u);
        });

        function renderUnit(unit, depth = 0) {
          const div = document.createElement('div');
          div.className = 'border-l-2 pl-4 ml-' + depth*2 + ' border-gray-300';
          div.innerHTML = `<p class="font-semibold text-lg">${unit.name}</p>`;

          // Roles under this unit
          const unitRoles = roles.filter(r => r.org_unit_id === unit.id);
          if (unitRoles.length > 0) {
            const ul = document.createElement('ul');
            ul.className = 'ml-4 list-disc';
            unitRoles.forEach(r => {
              const li = document.createElement('li');
              li.textContent = (people[r.person_id] || 'Unknown') +
                (r.is_manager ? ' (Manager)' : '') +
                (r.description ? ` — ${r.description}` : '');
              ul.appendChild(li);
            });
            div.appendChild(ul);
          }

          // Children
          const children = byParent[unit.id] || [];
          children.forEach(c => div.appendChild(renderUnit(c, depth + 1)));

          return div;
        }

        container.innerHTML = '';
        (byParent[0] || []).forEach(root => {
          container.appendChild(renderUnit(root));
        });

        if (units.length === 0) {
          container.innerHTML = '<p class="text-gray-500">No organization units defined yet.</p>';
        }
      } catch (err) {
        container.innerHTML = `<p class="text-red-600">Error: ${err.message}</p>`;
      }
    }

    loadOrg();
  </script>
</body>
</html>

