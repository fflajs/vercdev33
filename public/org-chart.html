<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Organization Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    details > summary::-webkit-details-marker { display: none; }
    details[open] summary .tw-caret { transform: rotate(90deg); }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-5xl mx-auto p-6">
    <!-- Header -->
    <header class="mb-6">
      <h1 class="text-2xl font-bold">Organization Manager</h1>
      <p id="context-line" class="mt-1 text-sm text-gray-600">Loading context…</p>
    </header>

    <!-- Controls -->
    <div class="mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex gap-2 items-center">
        <input id="new-root-name" type="text" placeholder="New root unit name"
               class="w-72 rounded border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-blue-200" />
        <button id="create-root-btn"
                class="rounded bg-blue-600 px-3 py-2 text-sm font-medium text-white opacity-60 cursor-not-allowed"
                title="Disabled until backend create endpoint is available">
          Create Root Unit
        </button>
      </div>
    </div>

    <!-- Tree container -->
    <div id="tree" class="space-y-3"></div>

    <!-- Footer nav -->
    <div class="mt-8 flex items-center justify-between">
      <a href="admin.html" class="text-blue-600 hover:underline">← Back to Admin Portal</a>
      <details class="w-full sm:w-auto">
        <summary class="cursor-pointer select-none text-sm text-gray-500">
          Debug log (open to view)
        </summary>
        <pre id="debug" class="mt-2 max-h-72 overflow-auto rounded bg-black/90 p-3 text-xs text-green-300"></pre>
      </details>
    </div>
  </div>

  <script>
    (function () {
      // --- Debug helper ------------------------------------------------------
      const $debug = document.getElementById('debug');
      const log = (msg, obj) => {
        const line = `[${new Date().toISOString()}] ${msg}`;
        $debug.textContent += line + (obj ? ' ' + JSON.stringify(obj) : '') + '\n';
        console.log(msg, obj ?? null);
      };

      // --- DOM els -----------------------------------------------------------
      const $context = document.getElementById('context-line');
      const $tree = document.getElementById('tree');
      const $newRootName = document.getElementById('new-root-name');
      const $createRootBtn = document.getElementById('create-root-btn');

      // --- URL params --------------------------------------------------------
      const qs = new URLSearchParams(location.search);
      const roleId = qs.get('role_id');

      // --- State -------------------------------------------------------------
      let iteration = null;
      let units = [];
      let roles = [];
      let people = [];
      // maps
      let childrenByParent = new Map();
      let rolesByUnit = new Map();

      // --- Safe helpers ------------------------------------------------------
      const arr = (v) => Array.isArray(v) ? v : [];
      const byId = (list) => {
        const m = new Map();
        arr(list).forEach(it => { if (it && typeof it.id !== 'undefined') m.set(it.id, it); });
        return m;
      };

      // Build maps safely
      const buildMaps = () => {
        childrenByParent = new Map();
        rolesByUnit = new Map();

        arr(units).forEach(u => {
          const parentId = u.parent_id ?? null;
          if (!childrenByParent.has(parentId)) childrenByParent.set(parentId, []);
          childrenByParent.get(parentId).push(u);
        });

        arr(roles).forEach(r => {
          const key = r.org_unit_id;
          if (!rolesByUnit.has(key)) rolesByUnit.set(key, []);
          rolesByUnit.get(key).push(r);
        });

        // Ensure every unit id has an array entry (prevents undefined.forEach)
        arr(units).forEach(u => {
          if (!rolesByUnit.has(u.id)) rolesByUnit.set(u.id, []);
          if (!childrenByParent.has(u.id)) childrenByParent.set(u.id, []);
        });
      };

      // --- Render ------------------------------------------------------------
      function renderTree() {
        $tree.innerHTML = '';
        if (!iteration) {
          $tree.innerHTML = `<div class="rounded border border-amber-300 bg-amber-50 px-3 py-2 text-sm text-amber-700">
            No active iteration loaded. (Nothing to show.)
          </div>`;
          return;
        }

        const roots = childrenByParent.get(null) || [];
        if (roots.length === 0) {
          $tree.innerHTML = `<div class="rounded border border-blue-200 bg-blue-50 px-3 py-2 text-sm text-blue-700">
            No organization units defined yet for this iteration.
          </div>`;
          return;
        }

        const $ul = document.createElement('ul');
        $ul.className = 'space-y-2';

        roots.forEach(root => {
          $ul.appendChild(renderUnit(root));
        });

        $tree.appendChild($ul);
      }

      function renderUnit(unit) {
        const $li = document.createElement('li');

        const unitRoles = rolesByUnit.get(unit.id) || [];
        const managers = unitRoles.filter(r => r.is_manager);
        const members  = unitRoles.filter(r => !r.is_manager);

        const childUnits = childrenByParent.get(unit.id) || [];

        const $box = document.createElement('div');
        $box.className = 'rounded border border-gray-200 bg-white p-3 shadow-sm';

        // Header line
        const $hdr = document.createElement('div');
        $hdr.className = 'flex items-center justify-between gap-3';
        $hdr.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="tw-caret inline-block rotate-0 transition-transform">▶</span>
            <span class="font-semibold">${unit.name}</span>
            <span class="text-xs text-gray-400">#${unit.id}</span>
          </div>
          <div class="text-xs text-gray-400">Parent: ${unit.parent_id ?? '—'}</div>
        `;
        $box.appendChild($hdr);

        // People lists
        const $peopleWrap = document.createElement('div');
        $peopleWrap.className = 'mt-2 grid gap-2 md:grid-cols-2';
        $peopleWrap.innerHTML = `
          <div>
            <div class="text-xs font-semibold text-gray-500">Managers</div>
            <ul class="mt-1 list-disc pl-5 text-sm">
              ${arr(managers).map(m => `<li>${escapeHtml(m.people?.name || '—')}</li>`).join('') || '<li class="text-gray-400">None</li>'}
            </ul>
          </div>
          <div>
            <div class="text-xs font-semibold text-gray-500">Members</div>
            <ul class="mt-1 list-disc pl-5 text-sm">
              ${arr(members).map(m => `<li>${escapeHtml(m.people?.name || '—')}</li>`).join('') || '<li class="text-gray-400">None</li>'}
            </ul>
          </div>
        `;
        $box.appendChild($peopleWrap);

        // Children (recursive)
        if (childUnits.length > 0) {
          const $kids = document.createElement('ul');
          $kids.className = 'mt-3 ml-6 space-y-2 border-l border-gray-200 pl-4';
          childUnits.forEach(ch => $kids.appendChild(renderUnit(ch)));
          $box.appendChild($kids);
        }

        $li.appendChild($box);
        return $li;
      }

      function escapeHtml(str) {
        if (typeof str !== 'string') return str;
        return str
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      // --- Data load ---------------------------------------------------------
      async function loadData() {
        try {
          let iterId = null;

          if (roleId) {
            log('[org-chart] Using role_id=' + roleId);
            const ctxRes = await fetch(`/api/admin/get-role-context?role_id=${encodeURIComponent(roleId)}`);
            const ctxJson = await ctxRes.json();
            log('[org-chart] get-role-context result', ctxJson);

            if (!ctxRes.ok || !ctxJson.success) {
              $context.textContent = 'Failed to load role context.';
              return;
            }
            iteration = { id: ctxJson.context.iterId, name: ctxJson.context.iterName, question_set: ctxJson.context.qset };
            iterId = iteration.id;
            $context.textContent = `User: ${ctxJson.context.user} — Role: ${ctxJson.context.roleType} — Unit: ${ctxJson.context.unitName} — Iteration: ${iteration.name} (ID: ${iterId}) — Question Set: ${iteration.question_set}`;
          } else {
            log('[org-chart] Admin mode (no role_id)');
            const iterRes = await fetch('/api/admin/active-iteration');
            const iterJson = await iterRes.json();
            log('[org-chart] active-iteration result', iterJson);

            if (!iterRes.ok || !iterJson.success || !iterJson.iteration) {
              $context.textContent = 'No active iteration.';
              return;
            }
            iteration = iterJson.iteration;
            iterId = iteration.id;
            $context.textContent = `Admin mode — Active Iteration: ${iteration.name} (ID: ${iterId}) — Question Set: ${iteration.question_set}`;
          }

          // Fetch org data
          const orgRes = await fetch(`/api/admin/org-data?iteration_id=${encodeURIComponent(iterId)}`);
          const orgJson = await orgRes.json();
          log('[org-chart] org-data result', orgJson);

          if (!orgRes.ok || !orgJson.success) {
            $tree.innerHTML = `<div class="rounded border border-rose-300 bg-rose-50 px-3 py-2 text-sm text-rose-700">
              ${escapeHtml(orgJson.message || 'Failed to load organization data.')}
            </div>`;
            return;
          }

          units = arr(orgJson.units);
          roles = arr(orgJson.roles);
          people = arr(orgJson.people);

          buildMaps();
          renderTree();
        } catch (e) {
          log('[org-chart] load error', { error: e?.message || String(e) });
          $tree.innerHTML = `<div class="rounded border border-rose-300 bg-rose-50 px-3 py-2 text-sm text-rose-700">
            Load failed: ${escapeHtml(e?.message || String(e))}
          </div>`;
        }
      }

      // --- Event wiring ------------------------------------------------------
      // NOTE: disabled; backend endpoint not guaranteed to exist in your current [action].js
      $createRootBtn.addEventListener('click', async () => {
        alert('Root creation is disabled until the backend endpoint is restored. (Button shown for layout parity.)');
      });

      // INIT
      log('[org-chart] page loaded');
      loadData();
    })();
  </script>
</body>
</html>

