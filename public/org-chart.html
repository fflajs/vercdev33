<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow">
    <h1 class="text-3xl font-bold mb-4">Organization Manager</h1>
    <p id="iteration-info" class="text-gray-600 mb-6">Loading...</p>
    <div id="org-tree"></div>
    <a href="/admin.html" class="inline-block mt-6 text-blue-500 hover:text-blue-700">‚Üê Back to Admin Portal</a>
  </div>

  <script>
    let currentIteration = null;
    let activeForm = null;

    async function loadIterationAndUnits() {
      const treeDiv = document.getElementById('org-tree');
      const iterationInfo = document.getElementById('iteration-info');
      treeDiv.innerHTML = 'Loading...';

      try {
        const res = await fetch('/api/admin/org-data?iteration_id=11'); // TODO: dynamic iteration later
        const data = await res.json();

        if (!data.success) {
          iterationInfo.textContent = 'Error: ' + data.message;
          return;
        }

        currentIteration = data.iteration;
        iterationInfo.textContent = `Current Iteration: ${currentIteration.name} (ID: ${currentIteration.id})`;

        treeDiv.innerHTML = '';
        const rootUnits = data.units.filter(u => !u.parent_id);
        rootUnits.forEach(unit => renderUnit(unit, data.units, data.roles, data.people, treeDiv));
      } catch (err) {
        treeDiv.innerHTML = `<p class="text-red-500">Error loading data: ${err.message}</p>`;
      }
    }

    function renderUnit(unit, allUnits, allRoles, allPeople, container) {
      const unitDiv = document.createElement('div');
      unitDiv.className = 'ml-4 mt-2';

      const title = document.createElement('div');
      title.className = 'font-semibold text-lg flex items-center';
      title.textContent = unit.name;

      const addLink = document.createElement('a');
      addLink.href = '#';
      addLink.textContent = ' [Add Subunit]';
      addLink.className = 'text-sm text-blue-500 ml-2 hover:underline';
      addLink.onclick = (e) => {
        e.preventDefault();
        showInlineSubunitForm(unit.id, unitDiv);
      };
      title.appendChild(addLink);

      unitDiv.appendChild(title);

      // Show roles
      const rolesHere = allRoles.filter(r => r.org_unit_id === unit.id);
      rolesHere.forEach(role => {
        const person = allPeople.find(p => p.id === role.person_id);
        const roleLine = document.createElement('div');
        roleLine.className = 'ml-6 text-gray-700';
        roleLine.textContent = `- ${person ? person.name : 'Unknown'} (${role.is_manager ? 'Manager' : 'Member'})`;
        unitDiv.appendChild(roleLine);
      });

      // Render children
      const children = allUnits.filter(u => u.parent_id === unit.id);
      children.forEach(child => renderUnit(child, allUnits, allRoles, allPeople, unitDiv));

      container.appendChild(unitDiv);
    }

    function showInlineSubunitForm(parentId, unitDiv) {
      // Close previous
      if (activeForm) {
        activeForm.remove();
        activeForm = null;
      }

      const form = document.createElement('div');
      form.className = 'ml-6 mt-2 p-2 border rounded bg-gray-50';

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Subunit name';
      input.className = 'border rounded px-2 py-1 mr-2';

      const submitBtn = document.createElement('button');
      submitBtn.textContent = 'Create';
      submitBtn.className = 'bg-green-500 text-white px-2 py-1 rounded';
      submitBtn.onclick = async () => {
        const name = input.value.trim();
        if (!name) return alert('Please enter a name.');

        const res = await fetch('/api/admin/create-org-unit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, parent_id: parentId, iteration_id: currentIteration.id })
        });

        const data = await res.json();
        if (data.success) {
          loadIterationAndUnits();
        } else {
          alert('Error: ' + data.message);
        }
      };

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'ml-2 bg-gray-400 text-white px-2 py-1 rounded';
      cancelBtn.onclick = () => {
        form.remove();
        activeForm = null;
      };

      form.appendChild(input);
      form.appendChild(submitBtn);
      form.appendChild(cancelBtn);

      // Attach just below the unit
      unitDiv.appendChild(form);

      activeForm = form;
      input.focus();
    }

    document.addEventListener('DOMContentLoaded', loadIterationAndUnits);
  </script>
</body>
</html>

