<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-4xl bg-white p-8 rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold mb-4">Organization Manager</h1>
    <p id="iteration-info" class="text-gray-700 mb-6">Loading...</p>
    <div id="org-tree" class="space-y-4"></div>
    <a href="/admin.html" class="inline-block mt-6 text-blue-500 hover:text-blue-800">← Back to Admin Portal</a>
  </div>

  <script>
    let currentIteration = null;
    let activeForm = null;

    async function loadIterationAndUnits() {
      const res = await fetch('/api/admin/org-data?iteration_id=11');
      const data = await res.json();

      if (!data.success) {
        document.getElementById('iteration-info').textContent = 'Error loading iteration.';
        return;
      }

      currentIteration = data.iteration;
      document.getElementById('iteration-info').textContent =
        `Current Iteration: ${currentIteration.name} (ID: ${currentIteration.id})`;

      renderOrgUnits(data.units, data.roles, data.people);
    }

    function renderOrgUnits(units, roles, people) {
      const tree = document.getElementById('org-tree');
      tree.innerHTML = '';

      const unitMap = {};
      units.forEach(u => unitMap[u.id] = { ...u, children: [] });
      units.forEach(u => {
        if (u.parent_id) unitMap[u.parent_id].children.push(unitMap[u.id]);
      });

      const roots = units.filter(u => !u.parent_id).map(u => unitMap[u.id]);

      roots.forEach(root => {
        tree.appendChild(renderUnit(root, roles, people));
      });
    }

    function renderUnit(unit, roles, people) {
      const container = document.createElement('div');
      container.className = 'ml-4 border-l pl-4';

      const header = document.createElement('div');
      header.className = 'font-semibold text-lg flex items-center justify-between';

      const title = document.createElement('span');
      title.textContent = unit.name;
      header.appendChild(title);

      const addBtn = document.createElement('button');
      addBtn.textContent = '➕ Add Subunit';
      addBtn.className = 'ml-2 text-sm text-green-600 hover:underline';
      addBtn.onclick = () => showInlineSubunitForm(unit.id, container, header);
      header.appendChild(addBtn);

      container.appendChild(header);

      // roles for this unit
      const unitRoles = roles.filter(r => r.org_unit_id === unit.id);
      unitRoles.forEach(role => {
        const person = people.find(p => p.id === role.person_id);
        if (!person) return;

        const roleDiv = document.createElement('div');
        roleDiv.className = 'ml-4 flex items-center';

        const roleLabel = document.createElement('span');
        roleLabel.textContent = `- ${person.name} (${role.is_manager ? 'Manager' : 'Member'})`;
        roleDiv.appendChild(roleLabel);

        const delBtn = document.createElement('button');
        delBtn.textContent = '❌';
        delBtn.className = 'ml-2 text-xs text-red-500 hover:underline';
        delBtn.onclick = async () => {
          if (!confirm(`Remove ${person.name} from ${unit.name}?`)) return;
          const res = await fetch('/api/admin/delete-role', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: role.id })
          });
          const data = await res.json();
          if (data.success) {
            loadIterationAndUnits();
          } else {
            alert('Error removing role: ' + data.message);
          }
        };
        roleDiv.appendChild(delBtn);

        container.appendChild(roleDiv);
      });

      // Add Role inline form
      const roleForm = document.createElement('div');
      roleForm.className = 'ml-4 mt-2 flex items-center space-x-2';

      const personSelect = document.createElement('select');
      personSelect.className = 'border rounded px-2 py-1';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Select person';
      personSelect.appendChild(placeholder);
      people.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        personSelect.appendChild(opt);
      });

      const roleSelect = document.createElement('select');
      roleSelect.className = 'border rounded px-2 py-1';
      const optManager = document.createElement('option');
      optManager.value = 'true';
      optManager.textContent = 'Manager';
      const optMember = document.createElement('option');
      optMember.value = 'false';
      optMember.textContent = 'Member';
      roleSelect.appendChild(optManager);
      roleSelect.appendChild(optMember);

      const addRoleBtn = document.createElement('button');
      addRoleBtn.textContent = 'Add Role';
      addRoleBtn.className = 'bg-blue-500 text-white px-2 py-1 rounded';
      addRoleBtn.onclick = async () => {
        const personId = parseInt(personSelect.value);
        if (!personId) return alert('Please select a person.');
        const isManager = roleSelect.value === 'true';
        const res = await fetch('/api/admin/assign-role', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            person_id: personId,
            org_unit_id: unit.id,
            is_manager: isManager,
            iteration_id: currentIteration.id
          })
        });
        const data = await res.json();
        if (data.success) {
          loadIterationAndUnits();
        } else {
          alert('Error adding role: ' + data.message);
        }
      };

      roleForm.appendChild(personSelect);
      roleForm.appendChild(roleSelect);
      roleForm.appendChild(addRoleBtn);
      container.appendChild(roleForm);

      // render children
      unit.children.forEach(child => {
        container.appendChild(renderUnit(child, roles, people));
      });

      return container;
    }

    function showInlineSubunitForm(parentId, container, header) {
      if (activeForm) {
        activeForm.remove();
        activeForm = null;
      }

      const form = document.createElement('div');
      form.className = 'ml-4 mt-2 p-2 border rounded bg-gray-50 flex items-center';

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Subunit name';
      input.className = 'border rounded px-2 py-1 mr-2';

      const submitBtn = document.createElement('button');
      submitBtn.textContent = 'Create';
      submitBtn.className = 'bg-green-500 text-white px-2 py-1 rounded';
      submitBtn.onclick = async () => {
        const name = input.value.trim();
        if (!name) return alert('Please enter a name.');
        const res = await fetch('/api/admin/create-org-unit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, parent_id: parentId, iteration_id: currentIteration.id })
        });
        const data = await res.json();
        if (data.success) {
          loadIterationAndUnits();
        } else {
          alert('Error: ' + data.message);
        }
      };

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'ml-2 bg-gray-400 text-white px-2 py-1 rounded';
      cancelBtn.onclick = () => {
        form.remove();
        activeForm = null;
      };

      form.appendChild(input);
      form.appendChild(submitBtn);
      form.appendChild(cancelBtn);

      header.insertAdjacentElement('afterend', form);
      activeForm = form;
      input.focus();
    }

    loadIterationAndUnits();
  </script>
</body>
</html>

