<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Organization Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { @apply bg-white rounded-xl shadow p-4 border border-gray-100; }
    .btn { @apply inline-flex items-center justify-center rounded-md px-3 py-2 text-sm font-medium transition; }
    .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-700; }
    .btn-danger { @apply bg-red-600 text-white hover:bg-red-700; }
    .btn-neutral { @apply bg-gray-200 text-gray-800 hover:bg-gray-300; }
    .badge { @apply inline-block rounded-full px-2 py-0.5 text-xs font-semibold bg-gray-100 text-gray-700; }
    details > summary::-webkit-details-marker { display:none; }
    summary { @apply cursor-pointer select-none; }
    .debug { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-5xl mx-auto p-4 md:p-6">
    <header class="mb-4">
      <h1 class="text-2xl md:text-3xl font-bold">Organization Manager</h1>
      <p id="ctx" class="mt-1 text-sm text-gray-600">Loading…</p>
    </header>

    <!-- Root creation -->
    <div class="card mb-4">
      <div class="flex flex-col md:flex-row md:items-end gap-3">
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700">New root unit name</label>
          <input id="rootName" type="text" class="mt-1 w-full rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. Headquarters"/>
        </div>
        <button id="btnCreateRoot" class="btn btn-primary h-10">Create Root Unit</button>
        <a href="admin.html" class="btn btn-neutral h-10">← Back to Admin Portal</a>
      </div>
    </div>

    <!-- Tree -->
    <div id="tree" class="space-y-3"></div>

    <!-- Debug -->
    <div class="mt-8">
      <details>
        <summary class="text-sm text-gray-600 hover:text-gray-800 cursor-pointer">Debug log (open to view)</summary>
        <textarea id="debug" class="debug w-full h-48 mt-2 p-2 rounded border border-gray-300 bg-white" readonly></textarea>
      </details>
    </div>
  </div>

<script>
(function() {
  const debugEl = document.getElementById('debug');
  function dbg(msg, data) {
    const t = new Date().toISOString();
    if (data !== undefined) {
      console.log(`[org-chart] ${msg}`, data);
      debugEl.value += `[${t}] ${msg} ${JSON.stringify(data)}\n`;
    } else {
      console.log(`[org-chart] ${msg}`);
      debugEl.value += `[${t}] ${msg}\n`;
    }
    debugEl.scrollTop = debugEl.scrollHeight;
  }

  const qs = new URLSearchParams(location.search);
  const roleId = qs.get('role_id'); // dual-mode
  const ctxLine = document.getElementById('ctx');
  const treeEl = document.getElementById('tree');
  const btnCreateRoot = document.getElementById('btnCreateRoot');
  const rootNameInput = document.getElementById('rootName');

  let context = null; 
  let units = [];
  let roles = [];
  let people = [];
  let rolesByUnit = new Map();
  let childrenByParent = new Map();

  async function getJSON(url) {
    const r = await fetch(url);
    const j = await r.json().catch(() => ({}));
    return { ok: r.ok, json: j };
  }
  async function sendJSON(url, method, payload) {
    const r = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: payload ? JSON.stringify(payload) : undefined
    });
    const j = await r.json().catch(() => ({}));
    return { ok: r.ok, json: j };
  }

  function buildIndexes() {
    rolesByUnit = new Map();
    for (const r of roles) {
      const arr = rolesByUnit.get(r.org_unit_id) || [];
      arr.push(r);
      rolesByUnit.set(r.org_unit_id, arr);
    }
    childrenByParent = new Map();
    for (const u of units) {
      const p = u.parent_id ?? 'ROOT';
      const arr = childrenByParent.get(p) || [];
      arr.push(u);
      childrenByParent.set(p, arr);
    }
  }

  function renderTree() {
    treeEl.innerHTML = '';
    const roots = childrenByParent.get('ROOT') || [];
    for (const root of roots) {
      treeEl.appendChild(renderUnit(root));
    }
  }

  function renderUnit(u) {
    const card = document.createElement('div');
    card.className = 'card';

    const header = document.createElement('div');
    header.className = 'flex items-center justify-between';
    header.innerHTML = `
      <div class="flex items-center gap-2">
        <span class="badge">#${u.id}</span>
        <h3 class="text-lg font-semibold">${escapeHtml(u.name)}</h3>
        <span class="text-sm text-gray-500">Parent: ${u.parent_id ?? '—'}</span>
      </div>
      <div class="flex items-center gap-2">
        <button data-del="${u.id}" class="btn btn-danger">Delete (Cascade)</button>
      </div>
    `;
    card.appendChild(header);

    // Managers / Members
    const unitRoles = rolesByUnit.get(u.id) || [];
    const managers = unitRoles.filter(r => r.is_manager);
    const members  = unitRoles.filter(r => !r.is_manager);

    const lists = document.createElement('div');
    lists.className = 'grid grid-cols-1 md:grid-cols-2 gap-3 mt-3';

    lists.appendChild(renderRoleList('Managers', managers));
    lists.appendChild(renderRoleList('Members', members));

    card.appendChild(lists);

    // Assign role
    card.appendChild(renderRoleAssignRow(u));

    // Add subunit
    card.appendChild(renderAddSubunitRow(u));

    // Children
    const kids = childrenByParent.get(u.id) || [];
    if (kids.length) {
      const childrenWrap = document.createElement('div');
      childrenWrap.className = 'mt-3 space-y-3';
      for (const k of kids) {
        childrenWrap.appendChild(renderUnit(k));
      }
      const details = document.createElement('details');
      details.open = true;
      const summary = document.createElement('summary');
      summary.className = 'text-sm text-gray-600 hover:text-gray-800';
      summary.innerText = 'Subunits';
      details.appendChild(summary);
      details.appendChild(childrenWrap);
      card.appendChild(details);
    }

    return card;
  }

  function renderRoleList(title, items) {
    const wrap = document.createElement('div');
    wrap.innerHTML = `<div class="text-sm font-medium text-gray-700">${title}</div>`;
    const list = document.createElement('div');
    list.className = 'mt-2 space-y-1';

    if (!items.length) {
      list.innerHTML = `<div class="text-sm text-gray-400">None</div>`;
    } else {
      for (const r of items) {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between rounded border border-gray-200 px-2 py-1';
        row.innerHTML = `
          <div class="text-sm">${escapeHtml(r.people?.name ?? '?')}</div>
          <button class="btn btn-danger h-7" data-remove-role="${r.id}">Remove</button>
        `;
        list.appendChild(row);
      }
    }

    wrap.appendChild(list);
    return wrap;
  }

  function renderRoleAssignRow(u) {
    const row = document.createElement('div');
    row.className = 'mt-3 flex flex-col md:flex-row gap-2 md:items-end';

    const sel = document.createElement('select');
    sel.className = 'rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500';
    sel.innerHTML = `<option value="">— Select person —</option>` + people.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
    sel.id = `sel-p-${u.id}`;

    const typeSel = document.createElement('select');
    typeSel.className = 'rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500';
    typeSel.innerHTML = `<option value="manager">Manager</option><option value="member">Member</option>`;
    typeSel.id = `sel-t-${u.id}`;

    const btn = document.createElement('button');
    btn.className = 'btn btn-primary h-10';
    btn.textContent = 'Assign';
    btn.addEventListener('click', async () => {
      const personId = +sel.value;
      const type = typeSel.value;
      if (!personId) {
        alert('Select a person');
        return;
      }
      await assignRole(u.id, personId, type === 'manager');
    });

    const col1 = document.createElement('div');
    col1.className = 'flex-1';
    col1.innerHTML = `<label class="block text-sm font-medium text-gray-700">Person</label>`;
    col1.appendChild(sel);

    const col2 = document.createElement('div');
    col2.innerHTML = `<label class="block text-sm font-medium text-gray-700">Role</label>`;
    col2.appendChild(typeSel);

    row.appendChild(col1);
    row.appendChild(col2);
    row.appendChild(btn);
    return row;
  }

  function renderAddSubunitRow(u) {
    const row = document.createElement('div');
    row.className = 'mt-3 flex flex-col md:flex-row gap-2 md:items-end';

    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'New subunit name';
    input.className = 'rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500 flex-1';
    input.id = `new-sub-${u.id}`;

    const btn = document.createElement('button');
    btn.className = 'btn btn-primary h-10';
    btn.textContent = 'Add Subunit';
    btn.addEventListener('click', async () => {
      const name = (input.value || '').trim();
      if (!name) { alert('Enter subunit name'); return; }
      await createUnit(name, u.id);
      input.value = '';
    });

    row.appendChild(input);
    row.appendChild(btn);
    return row;
  }

  function wireGlobalButtons() {
    treeEl.addEventListener('click', async (e) => {
      const delBtn = e.target.closest('button[data-del]');
      if (delBtn) {
        const id = +delBtn.getAttribute('data-del');
        if (!Number.isFinite(id)) return;
        if (!confirm('Delete this unit and ALL its subunits and roles?')) return;
        await deleteUnit(id);
      }
      const remBtn = e.target.closest('button[data-remove-role]');
      if (remBtn) {
        const rid = +remBtn.getAttribute('data-remove-role');
        if (!Number.isFinite(rid)) return;
        await removeRole(rid);
      }
    });

    btnCreateRoot.addEventListener('click', async () => {
      const name = (rootNameInput.value || '').trim();
      if (!name) { alert('Enter root unit name'); return; }
      await createUnit(name, null);
      rootNameInput.value = '';
    });
  }

  function escapeHtml(s) {
    return String(s ?? '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  async function assignRole(orgUnitId, personId, isManager) {
    dbg('Assigning role', { orgUnitId, personId, isManager });
    const payload = { person_id: personId, org_unit_id: orgUnitId, is_manager: !!isManager, iteration_id: context.iterId };
    const { ok, json } = await sendJSON('/api/admin/add-role', 'POST', payload);
    dbg('add-role result', json);
    if (!ok || !json.success) {
      alert(json.message || 'Failed to assign role');
      return;
    }
    await loadData();
  }

  async function removeRole(roleId) {
    dbg('Removing role', { roleId });
    const r = await fetch(`/api/admin/remove-role?role_id=${encodeURIComponent(roleId)}`, { method: 'DELETE' });
    const j = await r.json().catch(()=>({}));
    dbg('remove-role result', j);
    if (!r.ok || !j.success) {
      alert(j.message || 'Failed to remove role');
      return;
    }
    await loadData();
  }

  async function createUnit(name, parentId) {
    dbg('Creating unit', { name, parentId, iteration_id: context.iterId });
    const payload = { name, parent_id: parentId, iteration_id: context.iterId };
    const { ok, json } = await sendJSON('/api/admin/add-unit', 'POST', payload);
    dbg('add-unit result', json);
    if (!ok || !json.success) {
      alert(json.message || 'Failed to create unit');
      return;
    }
    await loadData();
  }

  async function deleteUnit(unitId) {
    dbg('Cascade deleting unit (with subunits & roles)', { unitId });
    const r = await fetch(`/api/admin/delete-unit?unit_id=${encodeURIComponent(unitId)}`, { method: 'DELETE' });
    const j = await r.json().catch(()=>({}));
    dbg('delete-unit result', j);
    if (!r.ok || !j.success) {
      alert(j.message || 'Failed to delete unit');
      return;
    }
    await loadData();
  }

  async function loadContext() {
    if (roleId) {
      dbg('Using role mode with role_id', roleId);
      const { ok, json } = await getJSON(`/api/admin/get-role-context?role_id=${encodeURIComponent(roleId)}`);
      dbg('get-role-context result', json);
      if (!ok || !json.success) throw new Error(json.message || 'Role context failed');
      context = { isAdminMode: false, user: json.context.user, roleType: json.context.roleType, unitName: json.context.unitName, iterId: json.context.iterId, iterName: json.context.iterName, qset: json.context.qset };
      ctxLine.textContent = `User: ${context.user} — Role: ${context.roleType} — Unit: ${context.unitName} — Iteration: ${context.iterName} (ID: ${context.iterId}) — Question Set: ${context.qset}`;
    } else {
      dbg('Admin mode (no role_id)');
      const { ok, json } = await getJSON('/api/admin/active-iteration');
      dbg('active-iteration result', json);
      if (!ok || !json.success) throw new Error(json.message || 'No active iteration');
      context = { isAdminMode: true, iterId: json.iteration.id, iterName: json.iteration.name, qset: json.iteration.question_set };
      ctxLine.textContent = `Admin mode — Active Iteration: ${context.iterName} (ID: ${context.iterId}) — Question Set: ${context.qset}`;
    }
  }

  async function loadData() {
    dbg('Loading org-data for iteration', context.iterId);
    const { ok, json } = await getJSON(`/api/admin/org-data?iteration_id=${encodeURIComponent(context.iterId)}`);
    dbg('org-data result', json);
    if (!ok || !json.success) throw new Error(json.message || 'org-data failed');
    units = json.units || [];
    roles = json.roles || [];
    people = json.people || [];
    buildIndexes();
    renderTree();
  }

  async function init() {
    try {
      dbg('page loaded');
      wireGlobalButtons();
      await loadContext();
      await loadData();
    } catch (e) {
      console.error(e);
      alert(e.message || 'Failed to initialize');
      ctxLine.textContent = 'Initialization failed';
    }
  }

  init();
})();
</script>
</body>
</html>

