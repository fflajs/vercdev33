<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Organization Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-5xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Organization Manager</h1>

    <div id="context" class="mb-4 text-gray-700"></div>
    <div id="org-structure" class="space-y-4"></div>

    <div class="mt-6">
      <input type="text" id="newRootName" placeholder="New root unit name"
             class="border p-2 rounded mr-2" />
      <button id="createRootBtn"
              class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Create Root Unit
      </button>
    </div>

    <div class="mt-6">
      <a href="portal.html" class="text-blue-600 hover:underline">← Back to Admin Portal</a>
    </div>

    <!-- Debug -->
    <details class="mt-6">
      <summary class="cursor-pointer text-sm text-gray-500">Debug log (open to view)</summary>
      <pre id="debugLog" class="bg-black text-green-400 p-2 text-xs overflow-auto h-64"></pre>
    </details>
  </div>

  <script>
    const log = (msg, obj=null) => {
      const ts = new Date().toISOString();
      const line = obj ? `[${ts}] ${msg} ${JSON.stringify(obj)}` : `[${ts}] ${msg}`;
      document.getElementById("debugLog").textContent += line + "\n";
      console.log(msg, obj);
    };

    const urlParams = new URLSearchParams(window.location.search);
    const roleId = urlParams.get("role_id");

    async function loadData() {
      log("org-chart loaded");
      if (!roleId) {
        document.getElementById("context").innerHTML =
          `<div class="text-red-600">Missing role_id context</div>`;
        return;
      }

      log("Fetching role context for role_id=" + roleId);
      const ctxRes = await fetch(`/api/admin/get-role-context?role_id=${roleId}`);
      const ctxJson = await ctxRes.json();
      log("Response get-role-context", ctxJson);

      if (!ctxJson.success) {
        document.getElementById("context").innerHTML =
          `<div class="text-red-600">${ctxJson.message}</div>`;
        return;
      }

      const ctx = ctxJson.context;
      document.getElementById("context").innerHTML =
        `<div class="p-2 bg-gray-100 rounded border">
           <strong>User:</strong> ${ctx.user} —
           <strong>Role:</strong> ${ctx.roleType} —
           <strong>Unit:</strong> ${ctx.unitName} —
           <strong>Iteration:</strong> ${ctx.iterName} (ID: ${ctx.iterId}) —
           <strong>Question Set:</strong> ${ctx.qset}
         </div>`;

      log("Fetching org-data for iteration " + ctx.iterId);
      const dataRes = await fetch(`/api/admin/org-data?iteration_id=${ctx.iterId}`);
      const dataJson = await dataRes.json();
      log("Response org-data", dataJson);

      if (!dataJson.success) {
        document.getElementById("org-structure").innerHTML =
          `<div class="text-red-600">${dataJson.message}</div>`;
        return;
      }

      renderTree(dataJson.units, dataJson.roles, ctx.user, ctx.unitName);
    }

    function renderTree(units, roles, currentUser, currentUnitName) {
      const container = document.getElementById("org-structure");
      container.innerHTML = "";

      const map = {};
      units.forEach(u => { map[u.id] = {...u, children: []}; });
      units.forEach(u => { if (u.parent_id) map[u.parent_id].children.push(map[u.id]); });
      const roots = units.filter(u => !u.parent_id).map(u => map[u.id]);

      const roleMap = {};
      roles.forEach(r => {
        if (!roleMap[r.org_unit_id]) roleMap[r.org_unit_id] = [];
        roleMap[r.org_unit_id].push(r);
      });

      const createNode = (unit, depth=0) => {
        const indent = "&nbsp;".repeat(depth*4);
        let html = `<div class="ml-${depth*4}">
                      <div class="font-semibold ${unit.name === currentUnitName ? 'text-blue-600' : ''}">
                        ${indent}${unit.name}
                      </div>`;
        const rlist = roleMap[unit.id] || [];
        rlist.forEach(r => {
          html += `<div class="ml-6 ${r.people.name === currentUser ? 'bg-yellow-100 p-1 rounded' : ''}">
                     ${r.people.name} — ${r.is_manager ? 'Manager' : 'Member'}
                   </div>`;
        });
        unit.children.forEach(child => {
          html += createNode(child, depth+1);
        });
        html += `</div>`;
        return html;
      };

      roots.forEach(root => {
        container.innerHTML += createNode(root);
      });
    }

    document.getElementById("createRootBtn").onclick = async () => {
      const name = document.getElementById("newRootName").value.trim();
      if (!name) return;
      log("POST create-org-unit", {name, parent_id:null});
      const res = await fetch("/api/admin/create-org-unit", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({name, parent_id:null, iteration_id:2})
      });
      const json = await res.json();
      log("POST create-org-unit response", json);
      loadData();
    };

    loadData();
  </script>
</body>
</html>

