<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Organization Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #debug-log {
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.8rem;
      white-space: pre-wrap;
      background: #111;
      color: #0f0;
      padding: 0.5rem;
      border-radius: 0.5rem;
      display: none;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-5xl mx-auto p-6 bg-white rounded-lg shadow-md mt-8">
    <h1 class="text-2xl font-bold mb-4">Organization Manager</h1>
    <p id="iteration-info" class="text-blue-600 mb-4">Loading iteration...</p>
    <div id="org-container" class="space-y-4"></div>
    <a href="admin.html" class="mt-6 inline-block text-blue-600 hover:underline">← Back to Admin Portal</a>

    <!-- Debug Toggle -->
    <div class="mt-6">
      <button id="toggle-debug" class="px-3 py-1 bg-gray-700 text-white rounded">Debug log (open to view)</button>
      <div id="debug-log"></div>
    </div>
  </div>

  <script>
    const debugLogEl = document.getElementById("debug-log");
    const toggleDebugBtn = document.getElementById("toggle-debug");
    toggleDebugBtn.addEventListener("click", () => {
      debugLogEl.style.display = debugLogEl.style.display === "none" ? "block" : "none";
    });

    function logDebug(msg, data) {
      const time = new Date().toISOString();
      const line = `[${time}] ${msg}` + (data ? " " + JSON.stringify(data) : "");
      console.log(line);
      debugLogEl.textContent += line + "\n";
      debugLogEl.scrollTop = debugLogEl.scrollHeight;
    }

    async function loadIterationAndUnits() {
      try {
        logDebug("Fetching active iteration...");
        const iterRes = await fetch("/api/admin/active-iteration");
        const iterData = await iterRes.json();
        logDebug("Active iteration response", iterData);

        if (!iterData.success) {
          document.getElementById("iteration-info").textContent = "No active iteration found";
          return;
        }

        const iteration = iterData.iteration;
        document.getElementById("iteration-info").textContent =
          `Current Iteration: ${iteration.name} (ID: ${iteration.id})`;

        logDebug("Fetching org-data for iteration", { id: iteration.id });
        const res = await fetch(`/api/admin/org-data?iteration_id=${iteration.id}`);
        const data = await res.json();
        logDebug("Org-data response", data);

        if (!data.success) {
          document.getElementById("org-container").textContent =
            `Error loading iteration: ${data.message}`;
          return;
        }

        renderOrgUnits(data.orgUnits, data.roles);
      } catch (err) {
        console.error(err);
        document.getElementById("org-container").textContent =
          "Error loading iteration data.";
        logDebug("Error caught in loadIterationAndUnits", { error: err.message });
      }
    }

    function renderOrgUnits(orgUnits, roles) {
      const container = document.getElementById("org-container");
      container.innerHTML = "";

      if (!orgUnits || orgUnits.length === 0) {
        container.innerHTML = `<p class="text-gray-500">No organization units defined yet.</p>`;
        return;
      }

      orgUnits.forEach(unit => {
        const div = document.createElement("div");
        div.className = "p-3 border rounded";
        div.innerHTML = `
          <h2 class="font-semibold">${unit.name}</h2>
          <p class="text-sm text-gray-500">Unit ID: ${unit.id}</p>
          <button class="mt-2 px-3 py-1 bg-blue-500 text-white rounded">+ Add Subunit</button>
          <button class="mt-2 px-3 py-1 bg-red-500 text-white rounded">Delete Unit</button>
        `;

        const unitRoles = roles.filter(r => r.org_unit_id === unit.id);
        if (unitRoles.length > 0) {
          const ul = document.createElement("ul");
          ul.className = "list-disc ml-6 mt-2";
          unitRoles.forEach(r => {
            const li = document.createElement("li");
            li.textContent = `${r.role} → ${r.people ? r.people.name : "Unassigned"}`;
            ul.appendChild(li);
          });
          div.appendChild(ul);
        }

        container.appendChild(div);
      });
    }

    // --- INIT ---
    logDebug("org-chart.html loaded.");
    loadIterationAndUnits();
  </script>
</body>
</html>

