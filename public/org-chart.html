<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen">
  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Organization Manager</h1>
    <div id="iteration" class="mb-4"></div>
    <div id="org-container" class="mb-6"></div>
    <button id="addRootBtn" class="bg-blue-600 text-white px-4 py-2 rounded mb-6">Create Root Unit</button>
    <a href="portal.html" class="text-blue-600">← Back to Admin Portal</a>

    <!-- Debug -->
    <details class="mt-6">
      <summary class="cursor-pointer font-bold">Debug log (open to view)</summary>
      <pre id="debug" class="bg-black text-green-400 p-2 mt-2 rounded text-sm"></pre>
    </details>
  </div>

  <script>
    const debugEl = document.getElementById("debug");
    function log(...args) {
      const msg = `[${new Date().toISOString()}] ${args.join(" ")}\n`;
      debugEl.textContent += msg;
      console.log(...args);
    }

    const params = new URLSearchParams(window.location.search);
    const roleId = params.get("role_id");

    async function loadData() {
      log("org-chart loaded");
      if (!roleId) {
        log("❌ Missing role_id in query string");
        document.getElementById("iteration").innerText = "Error: Missing role_id context.";
        return;
      }

      try {
        log("Fetching active iteration via role context...");
        const res = await fetch(`/api/admin/get-role-context?role_id=${roleId}`);
        const json = await res.json();
        log("Response get-role-context", JSON.stringify(json));

        if (!json.success) {
          document.getElementById("iteration").innerText = "Error loading context: " + json.message;
          return;
        }

        const { context } = json;
        document.getElementById("iteration").innerText =
          `Current Iteration: ${context.iterName} (ID: ${context.iterId}) — Question Set: ${context.qset}`;
      } catch (err) {
        log("Error", err);
      }
    }

    document.getElementById("addRootBtn").addEventListener("click", async () => {
      log("Clicked Create Root Unit");
      // TODO: Implement create root call here
    });

    loadData();
  </script>
</body>
</html>

