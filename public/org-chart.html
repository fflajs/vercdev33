<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold mb-4">Organization Manager</h1>
    <p id="iteration-info" class="text-gray-600 mb-6">Loading...</p>
    <div id="org-tree" class="space-y-4"></div>
    <a href="/admin.html" class="inline-block mt-6 text-blue-500 hover:text-blue-700">‚Üê Back to Admin Portal</a>
  </div>

  <script>
    let currentIteration = null;
    let people = [];
    let activeForm = null;

    async function loadIterationAndUnits() {
      const res = await fetch('/api/admin/org-data?iteration_id=11'); // in production, fetch active iteration first
      const data = await res.json();
      if (!data.success) {
        document.getElementById('iteration-info').textContent = 'Error: ' + data.message;
        return;
      }

      currentIteration = data.iteration;
      people = data.people;

      document.getElementById('iteration-info').textContent =
        `Current Iteration: ${data.iteration.name} (ID: ${data.iteration.id})`;

      const container = document.getElementById('org-tree');
      container.innerHTML = '';
      renderOrgUnits(container, data.units, data.roles, null);
    }

    function renderOrgUnits(container, units, roles, parentId) {
      const children = units.filter(u => u.parent_id === parentId);
      children.forEach(unit => {
        const unitDiv = document.createElement('div');
        unitDiv.className = 'ml-6 border-l pl-4';

        // header line
        const header = document.createElement('div');
        header.className = 'flex items-center space-x-2 font-semibold text-lg';

        const nameSpan = document.createElement('span');
        nameSpan.textContent = unit.name;

        const addSubBtn = document.createElement('button');
        addSubBtn.textContent = '+ Add Subunit';
        addSubBtn.className = 'text-sm text-green-600 hover:underline ml-2';
        addSubBtn.onclick = () => showInlineSubunitForm(unit.id, unitDiv);

        const addRoleBtn = document.createElement('button');
        addRoleBtn.textContent = '+ Add Role';
        addRoleBtn.className = 'text-sm text-blue-600 hover:underline ml-2';
        addRoleBtn.onclick = () => showInlineRoleForm(unit.id, unitDiv);

        header.appendChild(nameSpan);
        header.appendChild(addSubBtn);
        header.appendChild(addRoleBtn);
        unitDiv.appendChild(header);

        // roles
        const unitRoles = roles.filter(r => r.org_unit_id === unit.id);
        unitRoles.forEach(role => {
          const person = people.find(p => p.id === role.person_id);
          const roleDiv = document.createElement('div');
          roleDiv.className = 'ml-4 text-gray-700 flex items-center';

          roleDiv.textContent = `- ${person ? person.name : 'Unknown'} (${role.is_manager ? 'Manager' : 'Member'})`;

          const delBtn = document.createElement('button');
          delBtn.textContent = 'Remove';
          delBtn.className = 'ml-2 text-xs text-red-600 hover:underline';
          delBtn.onclick = async () => {
            if (!confirm('Remove this role?')) return;
            await fetch('/api/admin/delete-role', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: role.id })
            });
            loadIterationAndUnits();
          };

          roleDiv.appendChild(delBtn);
          unitDiv.appendChild(roleDiv);
        });

        container.appendChild(unitDiv);

        // recurse
        renderOrgUnits(unitDiv, units, roles, unit.id);
      });
    }

    function showInlineSubunitForm(parentId, container) {
      if (activeForm) { activeForm.remove(); activeForm = null; }

      const form = document.createElement('div');
      form.className = 'ml-8 mt-2 p-2 border rounded bg-gray-50 flex space-x-2';

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Subunit name';
      input.className = 'border rounded px-2 py-1 flex-1';

      const createBtn = document.createElement('button');
      createBtn.textContent = 'Create';
      createBtn.className = 'bg-green-500 text-white px-2 py-1 rounded';
      createBtn.onclick = async () => {
        const name = input.value.trim();
        if (!name) return alert('Enter a name');
        await fetch('/api/admin/create-org-unit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, parent_id: parentId, iteration_id: currentIteration.id })
        });
        loadIterationAndUnits();
      };

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'bg-gray-400 text-white px-2 py-1 rounded';
      cancelBtn.onclick = () => { form.remove(); activeForm = null; };

      form.appendChild(input);
      form.appendChild(createBtn);
      form.appendChild(cancelBtn);
      container.insertBefore(form, container.children[1]);

      activeForm = form;
      input.focus();
    }

    function showInlineRoleForm(orgUnitId, container) {
      if (activeForm) { activeForm.remove(); activeForm = null; }

      const form = document.createElement('div');
      form.className = 'ml-8 mt-2 p-2 border rounded bg-gray-50 flex space-x-2';

      // person dropdown
      const personSelect = document.createElement('select');
      personSelect.className = 'border rounded px-2 py-1 flex-1';
      people.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        personSelect.appendChild(opt);
      });

      // role type dropdown
      const roleSelect = document.createElement('select');
      roleSelect.className = 'border rounded px-2 py-1';
      [{ val: true, label: 'Manager' }, { val: false, label: 'Member' }].forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.val;
        opt.textContent = r.label;
        roleSelect.appendChild(opt);
      });

      const createBtn = document.createElement('button');
      createBtn.textContent = 'Assign';
      createBtn.className = 'bg-blue-500 text-white px-2 py-1 rounded';
      createBtn.onclick = async () => {
        const person_id = parseInt(personSelect.value);
        const is_manager = roleSelect.value === 'true';
        const res = await fetch('/api/admin/assign-role', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ person_id, org_unit_id: orgUnitId, is_manager, iteration_id: currentIteration.id })
        });
        const data = await res.json();
        if (!data.success) alert('Error: ' + data.message);
        loadIterationAndUnits();
      };

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'bg-gray-400 text-white px-2 py-1 rounded';
      cancelBtn.onclick = () => { form.remove(); activeForm = null; };

      form.appendChild(personSelect);
      form.appendChild(roleSelect);
      form.appendChild(createBtn);
      form.appendChild(cancelBtn);

      container.insertBefore(form, container.children[1]);
      activeForm = form;
    }

    loadIterationAndUnits();
  </script>
</body>
</html>

