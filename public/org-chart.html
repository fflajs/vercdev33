<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold mb-4">Organization Manager</h1>
    <p id="iteration-display" class="text-blue-600 font-semibold mb-6">Loading...</p>

    <!-- Create new org unit form -->
    <div class="mb-6">
      <h2 class="text-xl font-bold mb-2">Create Sub-Organization</h2>
      <form id="org-form" class="space-y-4">
        <div>
          <label class="block text-gray-700">Name</label>
          <input type="text" id="org-name" class="border rounded w-full py-2 px-3" required>
        </div>
        <div>
          <label class="block text-gray-700">Parent Org Unit</label>
          <select id="parent-id" class="border rounded w-full py-2 px-3"></select>
        </div>
        <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
          Create
        </button>
      </form>
    </div>

    <!-- Org chart tree -->
    <div id="org-tree" class="text-gray-800"></div>

    <!-- Back link -->
    <a href="/admin.html" class="text-blue-500 hover:text-blue-700 mt-6 inline-block">‚Üê Back to Admin Portal</a>
  </div>

  <script>
    let currentIterationId = null;
    let orgUnits = [];

    async function loadIterationAndUnits(iterationId) {
      try {
        const res = await fetch(`/api/admin/org-data?iteration_id=${iterationId}`);
        const data = await res.json();
        if (!data.success) throw new Error(data.message);

        currentIterationId = data.iteration.id;
        document.getElementById('iteration-display').textContent =
          `Current Iteration: ${data.iteration.name} (ID: ${data.iteration.id})`;

        orgUnits = data.units;
        populateParentDropdown(orgUnits);
        renderOrgUnits(data.units, data.roles, data.people);
      } catch (err) {
        document.getElementById('iteration-display').textContent = "Error: " + err.message;
        document.getElementById('iteration-display').classList.replace("text-blue-600", "text-red-600");
      }
    }

    function populateParentDropdown(units) {
      const dropdown = document.getElementById('parent-id');
      dropdown.innerHTML = '<option value="">(no parent)</option>';
      units.forEach(unit => {
        const option = document.createElement('option');
        option.value = unit.id;
        option.textContent = unit.name;
        dropdown.appendChild(option);
      });
    }

    function renderOrgUnits(units, roles, people) {
      const container = document.getElementById('org-tree');
      container.innerHTML = '';

      function buildTree(parentId) {
        const children = units.filter(u => u.parent_id === parentId);
        if (!children.length) return '';

        let html = '<ul class="ml-6 list-disc">';
        for (const child of children) {
          html += `<li><strong>${child.name}</strong>`;
          const assignedRoles = roles.filter(r => r.org_unit_id === child.id);
          assignedRoles.forEach(role => {
            const person = people.find(p => p.id === role.person_id);
            if (person) {
              html += `<div class="ml-4 text-sm text-gray-700">- ${person.name} (${role.is_manager ? 'Manager' : 'Member'}) ${role.description || ''}</div>`;
            }
          });
          html += buildTree(child.id);
          html += `</li>`;
        }
        html += '</ul>';
        return html;
      }

      container.innerHTML = buildTree(null) || "No organization units defined yet.";
    }

    // Handle sub-org creation
    document.getElementById('org-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('org-name').value.trim();
      const parentId = document.getElementById('parent-id').value || null;

      try {
        const res = await fetch('/api/admin/create-org-unit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, parent_id: parentId ? parseInt(parentId) : null, iteration_id: currentIterationId })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);

        alert(`Org unit "${name}" created`);
        document.getElementById('org-form').reset();
        await loadIterationAndUnits(currentIterationId); // auto-refresh tree
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

    // Load initial iteration/org tree
    (async () => {
      try {
        const res = await fetch('/api/admin/active-iteration');
        const data = await res.json();
        if (data.success && data.iteration) {
          await loadIterationAndUnits(data.iteration.id);
        } else {
          document.getElementById('iteration-display').textContent = "No active iteration found.";
        }
      } catch {
        document.getElementById('iteration-display').textContent = "Error loading iteration.";
      }
    })();
  </script>
</body>
</html>

