<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Organization Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-5xl mx-auto py-8 px-4">
    <h1 class="text-3xl font-bold mb-4 text-center">Organization Manager</h1>
    <p id="iteration-info" class="text-center text-gray-600 mb-6">Loading current iteration...</p>
    <div id="org-container" class="space-y-4"></div>
    <p class="mt-8 text-center">
      <a href="admin.html" class="text-blue-500 hover:underline">&larr; Back to Admin Portal</a>
    </p>

    <!-- Debug log -->
    <details class="mt-6">
      <summary class="cursor-pointer text-sm text-gray-500">Debug log (open to view)</summary>
      <pre id="debug-log" class="text-xs bg-black text-green-400 p-2 mt-2 rounded h-64 overflow-y-auto"></pre>
    </details>
  </div>

  <script>
    const logEl = document.getElementById("debug-log");
    function debug(msg, obj) {
      const time = new Date().toISOString();
      if (obj) {
        logEl.textContent += `[${time}] ${msg} ${JSON.stringify(obj)}\n`;
      } else {
        logEl.textContent += `[${time}] ${msg}\n`;
      }
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function loadIterationAndUnits() {
      try {
        debug("org-chart.html loaded.");
        debug("Fetching active iteration...");

        const iterRes = await fetch("/api/admin/active-iteration");
        const iterJson = await iterRes.json();
        debug("Active iteration response", iterJson);

        if (!iterJson.success) {
          document.getElementById("iteration-info").textContent = "No active iteration found";
          return;
        }

        const iteration = iterJson.iteration;
        document.getElementById("iteration-info").textContent =
          `Current Iteration: ${iteration.name} (ID: ${iteration.id})`;

        debug("Fetching org-data for iteration", iteration);

        const orgRes = await fetch(`/api/admin/org-data?iteration_id=${iteration.id}`);
        const orgJson = await orgRes.json();
        debug("Org-data response", orgJson);

        if (!orgJson.success) {
          document.getElementById("org-container").innerHTML =
            `<p class="text-red-500">Error loading iteration: ${orgJson.message}</p>`;
          return;
        }

        renderOrgData(orgJson);
      } catch (err) {
        debug("Exception", { error: err.message });
        document.getElementById("org-container").innerHTML =
          `<p class="text-red-500">Unexpected error loading iteration</p>`;
      }
    }

    function renderOrgData(data) {
      const container = document.getElementById("org-container");
      container.innerHTML = "";

      if (!data.units || data.units.length === 0) {
        container.innerHTML = `<p class="text-gray-500">No organization units defined yet.</p>`;
        return;
      }

      data.units.forEach(unit => {
        const unitDiv = document.createElement("div");
        unitDiv.className = "p-4 bg-white rounded shadow";
        unitDiv.innerHTML = `
          <h2 class="text-xl font-semibold mb-2">${unit.name}</h2>
          <div class="mb-2">
            <button class="px-2 py-1 bg-green-500 text-white rounded text-sm add-role-btn" data-unit="${unit.id}">+ Add Role</button>
            <button class="px-2 py-1 bg-red-500 text-white rounded text-sm remove-unit-btn" data-unit="${unit.id}">Delete Unit</button>
          </div>
          <ul class="space-y-1" id="roles-${unit.id}"></ul>
        `;

        const roleList = unitDiv.querySelector(`#roles-${unit.id}`);
        const unitRoles = data.roles.filter(r => r.org_unit_id === unit.id);

        if (unitRoles.length === 0) {
          roleList.innerHTML = `<li class="text-gray-400 text-sm">No roles yet.</li>`;
        } else {
          unitRoles.forEach(r => {
            const li = document.createElement("li");
            li.className = "flex justify-between items-center text-sm";
            li.innerHTML = `
              <span>${r.person_name} â€” <em>${r.role}</em></span>
              <button class="px-2 py-1 bg-red-400 text-white rounded text-xs remove-role-btn" data-role="${r.id}">Remove</button>
            `;
            roleList.appendChild(li);
          });
        }

        container.appendChild(unitDiv);
      });

      // attach handlers
      document.querySelectorAll(".add-role-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const unitId = btn.getAttribute("data-unit");
          debug("TODO: Add role clicked", { unitId });
          alert(`Add role for unit ${unitId} (not yet implemented).`);
        });
      });
      document.querySelectorAll(".remove-unit-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const unitId = btn.getAttribute("data-unit");
          debug("TODO: Remove unit clicked", { unitId });
          alert(`Remove unit ${unitId} (not yet implemented).`);
        });
      });
      document.querySelectorAll(".remove-role-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const roleId = btn.getAttribute("data-role");
          debug("TODO: Remove role clicked", { roleId });
          alert(`Remove role ${roleId} (not yet implemented).`);
        });
      });
    }

    loadIterationAndUnits();
  </script>
</body>
</html>

