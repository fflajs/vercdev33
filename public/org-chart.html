<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Manager</title>
  <link rel="icon" href="/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-4xl bg-white p-8 rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold mb-4 text-center">Organization Manager</h1>
    <p id="iteration-info" class="text-gray-600 mb-6 text-center">Loading...</p>
    <div id="org-container" class="space-y-4"></div>
    <div class="text-center mt-6">
      <a href="/admin.html" class="text-blue-500 hover:text-blue-800 font-bold text-sm">‚Üê Back to Admin Portal</a>
    </div>
  </div>

  <script>
    let currentIteration = null;
    let activeForm = null;

    async function loadIterationAndUnits() {
      console.log("[DEBUG] ‚û°Ô∏è Loading active iteration...");
      try {
        const iterRes = await fetch('/api/admin/active-iteration');
        const iterData = await iterRes.json();
        if (!iterRes.ok || !iterData.success) {
          throw new Error(iterData.message || 'Failed to load active iteration');
        }
        currentIteration = iterData.iteration;
        document.getElementById('iteration-info').textContent =
          `Current Iteration: ${currentIteration.name} (ID: ${currentIteration.id})`;

        console.log("[DEBUG] Active Iteration:", currentIteration);

        const res = await fetch(`/api/admin/org-data?iteration_id=${currentIteration.id}`);
        const data = await res.json();
        console.log("[DEBUG] Org Data Response:", data);

        if (!res.ok || !data.success) {
          throw new Error(data.message || 'Failed to load organization data');
        }
        renderOrgUnits(data.units, data.roles, data.people);
      } catch (err) {
        console.error("[DEBUG] Error loading iteration/org data:", err);
        document.getElementById('iteration-info').textContent =
          `Error loading iteration: ${err.message}`;
        document.getElementById('iteration-info').classList.add('text-red-600');
      }
    }

    function renderOrgUnits(units, roles, people) {
      const container = document.getElementById('org-container');
      container.innerHTML = '';

      function renderUnit(unit, level = 0) {
        const div = document.createElement('div');
        div.className = `ml-${level * 4} border-l pl-4`;

        const header = document.createElement('div');
        header.className = 'flex items-center justify-between bg-gray-50 p-2 rounded';
        header.innerHTML = `
          <span class="font-semibold">${unit.name}</span>
          <div>
            <button onclick="showInlineSubunitForm(${unit.id}, this.parentElement.parentElement)" 
              class="text-green-600 text-sm font-bold mr-2">‚ûï Add Subunit</button>
            <button onclick="deleteOrgUnit(${unit.id})" 
              class="text-red-600 text-sm font-bold">üóë Delete</button>
          </div>
        `;
        div.appendChild(header);

        // Roles for this unit
        const unitRoles = roles.filter(r => r.org_unit_id === unit.id);
        unitRoles.forEach(role => {
          const person = people.find(p => p.id === role.person_id);
          if (!person) return;
          const roleDiv = document.createElement('div');
          roleDiv.className = 'ml-6 flex items-center';
          roleDiv.innerHTML = `
            - ${person.name} (${role.is_manager ? 'Manager' : 'Member'})
            <button onclick="deleteRole(${role.id})" 
              class="ml-2 text-xs text-red-500">‚ùå</button>
          `;
          div.appendChild(roleDiv);
        });

        // Inline add role form
        const addRoleDiv = document.createElement('div');
        addRoleDiv.className = 'ml-6 mt-2';
        const select = document.createElement('select');
        select.className = 'border rounded px-2 py-1 mr-2';
        people.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          select.appendChild(opt);
        });
        const managerCb = document.createElement('input');
        managerCb.type = 'checkbox';
        managerCb.className = 'mr-1';
        const managerLbl = document.createElement('label');
        managerLbl.textContent = 'Manager';
        managerLbl.className = 'mr-2';
        const btn = document.createElement('button');
        btn.textContent = 'Add';
        btn.className = 'bg-blue-500 text-white px-2 py-1 rounded';
        btn.onclick = async () => {
          await assignRole(select.value, unit.id, managerCb.checked);
        };
        addRoleDiv.appendChild(select);
        addRoleDiv.appendChild(managerCb);
        addRoleDiv.appendChild(managerLbl);
        addRoleDiv.appendChild(btn);
        div.appendChild(addRoleDiv);

        // Children
        const children = units.filter(u => u.parent_id === unit.id);
        children.forEach(child => div.appendChild(renderUnit(child, level + 1)));

        return div;
      }

      // Render root units
      units.filter(u => !u.parent_id).forEach(root => {
        container.appendChild(renderUnit(root));
      });

      if (units.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500">No organization units defined yet.</p>';
      }
    }

    function showInlineSubunitForm(parentId, container) {
      if (activeForm) {
        activeForm.remove();
        activeForm = null;
      }
      const form = document.createElement('div');
      form.className = 'ml-6 mt-2 p-2 border rounded bg-gray-50 flex items-center';
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Subunit name';
      input.className = 'border rounded px-2 py-1 mr-2 flex-1';
      const submitBtn = document.createElement('button');
      submitBtn.textContent = 'Create';
      submitBtn.className = 'bg-green-500 text-white px-2 py-1 rounded';
      submitBtn.onclick = async () => {
        const name = input.value.trim();
        if (!name) return alert('Please enter a name.');
        const res = await fetch('/api/admin/create-org-unit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, parent_id: parentId, iteration_id: currentIteration.id })
        });
        const data = await res.json();
        if (data.success) {
          console.log("[DEBUG] Subunit created:", data.unit);
          loadIterationAndUnits();
        } else {
          alert('Error: ' + data.message);
        }
      };
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'ml-2 bg-gray-400 text-white px-2 py-1 rounded';
      cancelBtn.onclick = () => { form.remove(); activeForm = null; };
      form.appendChild(input);
      form.appendChild(submitBtn);
      form.appendChild(cancelBtn);
      container.appendChild(form);
      activeForm = form;
      input.focus();
    }

    async function assignRole(person_id, org_unit_id, is_manager) {
      try {
        const res = await fetch('/api/admin/assign-role', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ person_id, org_unit_id, is_manager, iteration_id: currentIteration.id })
        });
        const data = await res.json();
        if (data.success) {
          console.log("[DEBUG] Role assigned:", data.role);
          loadIterationAndUnits();
        } else {
          alert('Error assigning role: ' + data.message);
        }
      } catch (err) {
        alert('Error assigning role: ' + err.message);
      }
    }

    async function deleteRole(id) {
      try {
        const res = await fetch('/api/admin/delete-role', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        const data = await res.json();
        if (data.success) {
          console.log("[DEBUG] Role deleted:", id);
          loadIterationAndUnits();
        } else {
          alert('Error removing role: ' + data.message);
        }
      } catch (err) {
        alert('Error removing role: ' + err.message);
      }
    }

    async function deleteOrgUnit(id) {
      if (!confirm("Are you sure you want to delete this org unit?")) return;
      try {
        const res = await fetch('/api/admin/delete-org-unit', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        const data = await res.json();
        if (data.success) {
          console.log("[DEBUG] Org unit deleted:", id);
          loadIterationAndUnits();
        } else {
          alert('Error removing org unit: ' + data.message);
        }
      } catch (err) {
        alert('Error removing org unit: ' + err.message);
      }
    }

    document.addEventListener('DOMContentLoaded', loadIterationAndUnits);
  </script>
</body>
</html>

