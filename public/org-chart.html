<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Manager</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-4xl bg-white p-8 rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold mb-4 text-center">Organization Manager</h1>
    <p id="iteration-info" class="text-center text-gray-600 mb-6">Loading...</p>
    <div id="org-container" class="space-y-4"></div>
    <a href="/admin.html"
       class="block mt-6 text-center text-blue-500 hover:text-blue-700 font-semibold">← Back to Admin Portal</a>
  </div>

  <script>
    let currentIteration = null;
    let activeForm = null;

    async function loadIterationAndUnits() {
      try {
        const iterRes = await fetch('/api/admin/active-iteration');
        const iterData = await iterRes.json();
        if (!iterRes.ok || !iterData.success) {
          document.getElementById('iteration-info').textContent =
            'Error loading iteration: ' + (iterData.message || iterRes.statusText);
          return;
        }
        currentIteration = iterData.iteration;
        document.getElementById('iteration-info').textContent =
          `Current Iteration: ${currentIteration.name} (ID: ${currentIteration.id})`;

        const res = await fetch(`/api/admin/org-data?iteration_id=${currentIteration.id}`);
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.message || 'Failed to load organization data');
        }
        renderOrgUnits(data.units, data.roles, data.people);
      } catch (err) {
        document.getElementById('iteration-info').textContent = 'Error loading iteration: ' + err.message;
      }
    }

    function renderOrgUnits(units, roles, people) {
      const container = document.getElementById('org-container');
      container.innerHTML = '';

      if (!units || units.length === 0) {
        // Show inline form to create the first root org unit
        const rootForm = document.createElement('div');
        rootForm.className = 'p-4 border rounded bg-gray-50';
        rootForm.innerHTML = `
          <h2 class="text-lg font-semibold mb-2">Create Root Organization Unit</h2>
          <input id="root-unit-name" type="text" placeholder="Root org unit name"
                 class="border rounded px-2 py-1 mr-2">
          <button id="create-root-btn"
                  class="bg-green-500 text-white px-3 py-1 rounded">Create</button>
        `;
        container.appendChild(rootForm);

        document.getElementById('create-root-btn').onclick = async () => {
          const name = document.getElementById('root-unit-name').value.trim();
          if (!name) return alert('Please enter a name.');
          const res = await fetch('/api/admin/create-org-unit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, parent_id: null, iteration_id: currentIteration.id })
          });
          const data = await res.json();
          if (data.success) {
            loadIterationAndUnits();
          } else {
            alert('Error: ' + data.message);
          }
        };
        return;
      }

      // Build hierarchical tree
      const unitMap = {};
      units.forEach(u => unitMap[u.id] = { ...u, children: [] });
      units.forEach(u => {
        if (u.parent_id && unitMap[u.parent_id]) {
          unitMap[u.parent_id].children.push(unitMap[u.id]);
        }
      });
      const roots = units.filter(u => !u.parent_id);

      roots.forEach(root => {
        container.appendChild(renderUnitNode(root, unitMap, roles, people));
      });
    }

    function renderUnitNode(unit, unitMap, roles, people) {
      const div = document.createElement('div');
      div.className = 'ml-4 mt-2 p-2 border rounded bg-gray-50';
      div.innerHTML = `<strong>${unit.name}</strong>`;

      // Add Subunit link
      const addLink = document.createElement('a');
      addLink.href = '#';
      addLink.textContent = ' ➕ Add Subunit';
      addLink.className = 'ml-2 text-sm text-blue-500 hover:text-blue-700';
      addLink.onclick = (e) => {
        e.preventDefault();
        showInlineSubunitForm(unit.id, div);
      };
      div.appendChild(addLink);

      // Show roles under this unit
      const unitRoles = roles.filter(r => r.org_unit_id === unit.id);
      unitRoles.forEach(r => {
        const person = people.find(p => p.id === r.person_id);
        if (person) {
          const roleDiv = document.createElement('div');
          roleDiv.className = 'ml-4 flex items-center';
          roleDiv.innerHTML =
            `- ${person.name} (${r.is_manager ? 'Manager' : 'Member'})`;
          div.appendChild(roleDiv);
        }
      });

      // Render children
      const children = unitMap[unit.id].children;
      if (children && children.length > 0) {
        children.forEach(child => {
          div.appendChild(renderUnitNode(child, unitMap, roles, people));
        });
      }

      return div;
    }

    function showInlineSubunitForm(parentId, container) {
      if (activeForm) {
        activeForm.remove();
        activeForm = null;
      }

      const form = document.createElement('div');
      form.className = 'ml-4 mt-2 p-2 border rounded bg-gray-100';
      form.innerHTML = `
        <input type="text" placeholder="Subunit name"
               class="border rounded px-2 py-1 mr-2">
        <button class="bg-green-500 text-white px-2 py-1 rounded">Create</button>
        <button class="ml-2 bg-gray-400 text-white px-2 py-1 rounded">Cancel</button>
      `;
      const [input, createBtn, cancelBtn] = form.querySelectorAll('input, button');
      createBtn.onclick = async () => {
        const name = input.value.trim();
        if (!name) return alert('Please enter a name.');
        const res = await fetch('/api/admin/create-org-unit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, parent_id: parentId, iteration_id: currentIteration.id })
        });
        const data = await res.json();
        if (data.success) {
          loadIterationAndUnits();
        } else {
          alert('Error: ' + data.message);
        }
      };
      cancelBtn.onclick = () => {
        form.remove();
        activeForm = null;
      };
      container.insertBefore(form, container.children[1]); // put right under unit header
      activeForm = form;
      input.focus();
    }

    loadIterationAndUnits();
  </script>
</body>
</html>
