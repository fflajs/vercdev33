<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-3xl font-bold mb-4">Organization Manager</h1>
    <p id="iteration-display" class="text-blue-600 font-semibold mb-4"></p>
    <div id="org-tree" class="mb-8"></div>

    <h2 class="text-xl font-bold mb-2">Add Sub-Organization</h2>
    <form id="suborg-form" class="space-y-4">
      <div>
        <label for="unit-name" class="block text-sm font-medium text-gray-700">Sub-Org Name</label>
        <input id="unit-name" type="text" required class="mt-1 block w-full border rounded p-2">
      </div>
      <div>
        <label for="parent-id" class="block text-sm font-medium text-gray-700">Parent Unit ID</label>
        <input id="parent-id" type="number" required class="mt-1 block w-full border rounded p-2">
      </div>
      <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Create Sub-Org</button>
    </form>

    <p id="message" class="mt-4 text-sm"></p>

    <a href="/admin.html" class="block mt-6 text-blue-500 hover:text-blue-700">← Back to Admin Portal</a>
  </div>

  <script>
    let currentIterationId = null;

    async function loadOrgData() {
      try {
        const res = await fetch('/api/admin/org-data?iteration_id=11'); // TODO: make dynamic later
        if (!res.ok) throw new Error('Failed to load org data');
        const data = await res.json();

        if (!data.success) throw new Error(data.message);

        currentIterationId = data.iteration.id;
        document.getElementById('iteration-display').textContent =
          `Current Iteration: ${data.iteration.name} (ID: ${data.iteration.id})`;

        const tree = document.getElementById('org-tree');
        tree.innerHTML = renderTree(data.units, data.roles, data.people, null);
      } catch (err) {
        document.getElementById('iteration-display').textContent =
          `Error loading org data: ${err.message}`;
      }
    }

    function renderTree(units, roles, people, parentId) {
      const children = units.filter(u => u.parent_id === parentId);
      if (!children.length) return '';

      let html = '<ul class="ml-6 list-disc">';
      for (const unit of children) {
        const unitRoles = roles.filter(r => r.org_unit_id === unit.id);
        html += `<li><strong>${unit.name}</strong> (ID: ${unit.id})`;

        if (unitRoles.length) {
          html += '<ul class="ml-6 list-square">';
          for (const role of unitRoles) {
            const person = people.find(p => p.id === role.person_id);
            const roleLabel = role.is_manager ? '(Manager)' : '(Member)';
            html += `<li>${person ? person.name : 'Unknown'} ${roleLabel} — ${role.description || ''}</li>`;
          }
          html += '</ul>';
        }

        html += renderTree(units, roles, people, unit.id);
        html += '</li>';
      }
      html += '</ul>';
      return html;
    }

    document.getElementById('suborg-form').addEventListener('submit', async e => {
      e.preventDefault();
      const name = document.getElementById('unit-name').value.trim();
      const parentId = parseInt(document.getElementById('parent-id').value, 10);
      const message = document.getElementById('message');

      try {
        const res = await fetch('/api/admin/create-org-unit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, parent_id: parentId, iteration_id: currentIterationId })
        });
        const data = await res.json();

        if (!res.ok || !data.success) throw new Error(data.message);

        message.textContent = `✅ Sub-Org "${name}" created under parent ${parentId}`;
        message.className = 'mt-4 text-green-600';

        document.getElementById('suborg-form').reset();
        loadOrgData(); // refresh tree
      } catch (err) {
        message.textContent = `❌ ${err.message}`;
        message.className = 'mt-4 text-red-600';
      }
    });

    loadOrgData();
  </script>
</body>
</html>

