<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Organization Manager</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold mb-4">Organization Manager</h1>
    <div id="iterationInfo" class="mb-4 text-lg font-semibold text-gray-700"></div>
    <div id="orgContainer" class="space-y-4"></div>
    <a href="admin.html" class="mt-6 inline-block text-blue-500">← Back to Admin Portal</a>
  </div>

  <script>
    let currentIteration = null;
    let activeForm = null;

    async function loadIterationAndUnits() {
      try {
        const iterRes = await fetch('/api/admin/active-iteration');
        const iterData = await iterRes.json();
        if (!iterData.success) {
          document.getElementById('iterationInfo').textContent =
            'Error loading iteration: ' + (iterData.message || 'Unknown error');
          return;
        }
        currentIteration = iterData.iteration;
        document.getElementById('iterationInfo').textContent =
          `Current Iteration: ${currentIteration.name} (ID: ${currentIteration.id})`;

        const res = await fetch(`/api/admin/org-data?iteration_id=${currentIteration.id}`);
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'Failed to load org data');

        renderOrgUnits(data.units, data.roles, data.people);
      } catch (err) {
        console.error(err);
        document.getElementById('iterationInfo').textContent =
          'Error loading iteration: ' + err.message;
      }
    }

    function renderOrgUnits(units, roles, people) {
      const container = document.getElementById('orgContainer');
      container.innerHTML = '';

      if (!units || units.length === 0) {
        const msg = document.createElement('div');
        msg.textContent = 'No organization units defined yet. Create the first root unit:';
        container.appendChild(msg);

        showInlineSubunitForm(null, container);
        return;
      }

      const tree = buildTree(units);
      tree.forEach(unit => container.appendChild(renderUnit(unit, roles, people)));
    }

    function buildTree(units) {
      const lookup = {};
      units.forEach(u => (lookup[u.id] = { ...u, children: [] }));
      const roots = [];
      units.forEach(u => {
        if (u.parent_id) {
          lookup[u.parent_id].children.push(lookup[u.id]);
        } else {
          roots.push(lookup[u.id]);
        }
      });
      return roots;
    }

    function renderUnit(unit, roles, people) {
      const wrapper = document.createElement('div');
      wrapper.className = 'ml-4 border-l pl-4 mt-2';

      const header = document.createElement('div');
      header.className = 'font-semibold flex items-center';
      header.textContent = unit.name;

      // Add Subunit link
      const addLink = document.createElement('button');
      addLink.textContent = '➕ Add Subunit';
      addLink.className = 'ml-2 text-sm text-blue-500';
      addLink.onclick = () => showInlineSubunitForm(unit.id, wrapper);
      header.appendChild(addLink);

      // Delete Unit link
      const delUnit = document.createElement('button');
      delUnit.textContent = '❌';
      delUnit.className = 'ml-2 text-sm text-red-500';
      delUnit.onclick = async () => {
        if (!confirm(`Delete org unit "${unit.name}"?`)) return;
        const res = await fetch('/api/admin/delete-org-unit', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: unit.id }),
        });
        const data = await res.json();
        if (data.success) loadIterationAndUnits();
        else alert('Error removing org unit: ' + data.message);
      };
      header.appendChild(delUnit);

      wrapper.appendChild(header);

      // Roles assigned
      const unitRoles = roles.filter(r => r.org_unit_id === unit.id);
      unitRoles.forEach(r => {
        const person = people.find(p => p.id === r.person_id);
        if (!person) return;
        const roleDiv = document.createElement('div');
        roleDiv.className = 'ml-6 flex items-center text-sm';
        roleDiv.textContent = `- ${person.name} (${r.is_manager ? 'Manager' : 'Member'})`;

        const delBtn = document.createElement('button');
        delBtn.textContent = '❌';
        delBtn.className = 'ml-2 text-xs text-red-500';
        delBtn.onclick = async () => {
          if (!confirm(`Remove role for ${person.name}?`)) return;
          const res = await fetch('/api/admin/delete-role', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: r.id }),
          });
          const data = await res.json();
          if (data.success) loadIterationAndUnits();
          else alert('Error removing role: ' + data.message);
        };
        roleDiv.appendChild(delBtn);

        wrapper.appendChild(roleDiv);
      });

      // Add role form
      const roleForm = document.createElement('div');
      roleForm.className = 'ml-6 mt-1 flex items-center space-x-2';
      const personSelect = document.createElement('select');
      personSelect.className = 'border rounded px-1 py-0.5';
      const defaultOpt = document.createElement('option');
      defaultOpt.text = 'Select person';
      defaultOpt.value = '';
      personSelect.appendChild(defaultOpt);
      people.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.text = p.name;
        personSelect.appendChild(opt);
      });

      const managerCheck = document.createElement('input');
      managerCheck.type = 'checkbox';
      const managerLabel = document.createElement('label');
      managerLabel.textContent = 'Manager';
      managerLabel.className = 'ml-1 text-sm';

      const addBtn = document.createElement('button');
      addBtn.textContent = 'Add Role';
      addBtn.className = 'bg-green-500 text-white px-2 py-1 rounded text-sm';
      addBtn.onclick = async () => {
        const person_id = personSelect.value;
        if (!person_id) return alert('Select a person');
        const is_manager = managerCheck.checked;
        const res = await fetch('/api/admin/assign-role', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            person_id,
            org_unit_id: unit.id,
            is_manager,
            iteration_id: currentIteration.id,
          }),
        });
        const data = await res.json();
        if (data.success) loadIterationAndUnits();
        else alert('Error assigning role: ' + data.message);
      };

      roleForm.appendChild(personSelect);
      roleForm.appendChild(managerCheck);
      roleForm.appendChild(managerLabel);
      roleForm.appendChild(addBtn);
      wrapper.appendChild(roleForm);

      // Render children
      if (unit.children && unit.children.length > 0) {
        unit.children.forEach(c => wrapper.appendChild(renderUnit(c, roles, people)));
      }

      return wrapper;
    }

    function showInlineSubunitForm(parentId, container) {
      if (activeForm) {
        activeForm.remove();
        activeForm = null;
      }
      const form = document.createElement('div');
      form.className = 'ml-6 mt-2 p-2 border rounded bg-gray-50 flex items-center space-x-2';
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Subunit name';
      input.className = 'border rounded px-2 py-1';
      const submitBtn = document.createElement('button');
      submitBtn.textContent = 'Create';
      submitBtn.className = 'bg-green-500 text-white px-2 py-1 rounded';
      submitBtn.onclick = async () => {
        const name = input.value.trim();
        if (!name) return alert('Please enter a name.');
        const res = await fetch('/api/admin/create-org-unit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, parent_id: parentId, iteration_id: currentIteration.id }),
        });
        const data = await res.json();
        if (data.success) {
          loadIterationAndUnits();
        } else {
          alert('Error: ' + data.message);
        }
      };

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'ml-2 bg-gray-400 text-white px-2 py-1 rounded';
      cancelBtn.onclick = () => {
        form.remove();
        activeForm = null;
      };

      form.appendChild(input);
      form.appendChild(submitBtn);
      form.appendChild(cancelBtn);
      container.appendChild(form);
      activeForm = form;
      input.focus();
    }

    loadIterationAndUnits();
  </script>
</body>
</html>

