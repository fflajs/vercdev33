<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cognitive Space Analysis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  <style>
    .tw-caret { transition: transform 0.2s; }
    details[open] summary .tw-caret { transform: rotate(90deg); }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root" class="max-w-5xl mx-auto p-6"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } = Recharts;

    function App() {
      const [context, setContext] = useState({});
      const [responses, setResponses] = useState([]);
      const [summary, setSummary] = useState(null);
      const [debug, setDebug] = useState([]);

      const log = (msg, obj) => {
        const line = `[${new Date().toISOString()}] ${msg}`;
        const text = obj ? `${line} ${JSON.stringify(obj)}` : line;
        setDebug((d) => [...d.slice(-80), text]);
      };

      useEffect(() => {
        const qs = new URLSearchParams(window.location.search);
        const name = qs.get("name");
        const role_id = qs.get("role_id");
        const iter_id = qs.get("iter_id");
        const qset = qs.get("qset");
        setContext({ name, role_id, iter_id, qset });
        log("[analyze] page loaded");

        async function load() {
          try {
            // 1️⃣ Fetch responses
            log("[analyze] GET /api/admin/cog-get-responses", { iter_id });
            const r1 = await fetch(`/api/admin/cog-get-responses?iteration_id=${iter_id}`);
            const d1 = await r1.json();
            if (!d1.success) throw new Error(d1.message);
            setResponses(d1.data);
            log("[analyze] responses loaded", { count: d1.data.length });

            // 2️⃣ Fetch summary stats
            log("[analyze] GET /api/admin/cog-summary");
            const r2 = await fetch(`/api/admin/cog-summary?iteration_id=${iter_id}`);
            const d2 = await r2.json();
            if (!d2.success) throw new Error(d2.message);
            setSummary(d2.data);
            log("[analyze] summary loaded", d2.data);
          } catch (err) {
            log("[analyze] error", { message: err.message });
          }
        }
        load();
      }, []);

      return (
        <div>
          <header className="mb-6">
            <h1 className="text-2xl font-bold">Cognitive Space Analysis</h1>
            <p className="text-sm text-gray-600 mt-1">
              User: {context.name} — Role ID: {context.role_id} — Iteration ID: {context.iter_id} — Question Set: {context.qset}
            </p>
          </header>

          {summary ? (
            <div className="space-y-6">
              <section>
                <h2 className="font-semibold text-lg mb-2">Analysis Summary</h2>
                <p className="text-sm text-gray-700 mb-3">
                  {summary.questions.length} questions analyzed. Average score:{" "}
                  <b>{summary.avg_score.toFixed(2)}</b> / 5.
                </p>

                <div className="rounded border bg-white p-4 shadow-sm">
                  <ResponsiveContainer width="100%" height={300}>
                    <BarChart data={summary.questions}>
                      <XAxis dataKey="q" tick={{ fontSize: 12 }} />
                      <YAxis domain={[0, 5]} />
                      <Tooltip />
                      <Bar dataKey="avg" fill="#10b981" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </section>

              <section>
                <h2 className="font-semibold text-lg mb-2">Raw Responses</h2>
                <table className="min-w-full border text-sm bg-white">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="border p-2">Person ID</th>
                      <th className="border p-2">Iteration</th>
                      <th className="border p-2">Q</th>
                      <th className="border p-2">Value</th>
                    </tr>
                  </thead>
                  <tbody>
                    {responses.map((r, i) => (
                      <tr key={i} className="odd:bg-gray-50">
                        <td className="border p-2">{r.person_id}</td>
                        <td className="border p-2">{r.iteration_id}</td>
                        <td className="border p-2">{r.q}</td>
                        <td className="border p-2 text-center">{r.v}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </section>
            </div>
          ) : (
            <p className="text-gray-500">Loading analysis...</p>
          )}

          <details className="bg-gray-900 text-gray-100 rounded-lg p-3 mt-8">
            <summary className="cursor-pointer flex items-center gap-2">
              <span className="tw-caret inline-block">▶</span>
              <span className="font-semibold">Debug log (open to view)</span>
            </summary>
            <pre className="mt-2 whitespace-pre-wrap text-xs">{debug.join("\n")}</pre>
          </details>

          <div className="mt-6">
            <a href="/portal.html" className="text-sm text-blue-600 hover:underline">
              ← Back to Portal
            </a>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>

